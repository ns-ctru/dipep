### Logistic Regression {.tabset .tabset-fade .tabset-pills}

```{r results_logistic_regression, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
## Test each outcome for association, then gather them *using broom) into one dataset for summarisation
logistic <- list()
## Age
logistic$age <- dipep_glm(df = dipep,
                          predictor = 'age',
                          model     = 'Age')
## Age (Categorised)
logistic$age.cat <- dipep_glm(df = dipep,
                              predictor = 'age.cat',
                              model     = 'Age (Binary)')
## Smoking
logistic$smoking <- dipep_glm(df = dipep,
                              predictor = 'smoking',
                              model = 'Smoking')
## Temperature (Categorised)
logistic$temperature.cat <- dipep_glm(df        = dipep,
                                      predictor = 'temperature.cat',
                                      model     = 'Temperature (Binary)')
## Temperature
logistic$temperature <- dipep_glm(df            = dipep,
                                  predictor     = 'temperature',
                                  model         = 'Temperature')
## BP Diastolic (Categorised)
logistic$bp.diastolic.cat <- dipep_glm(df        = dipep,
                                       predictor = 'bp.diastolic.cat',
                                       model     = 'Diastolic BP (Binary)')
## BP Diastolic
logistic$bp.diastolic <- dipep_glm(df        = dipep,
                                   predictor = 'bp.diastolic',
                                   model     = 'Diastolic BP')
## BP Systolic (Categorised)
## logistic$bp.systolic.cat <- dipep_glm(df = dipep,
##                                       predictor = 'bp.systolic.cat',
##                                       model     = Systolic BP (Binary)')
## BP Systolic
logistic$bp.systolic <- dipep_glm(df = dipep,
                                  predictor = 'bp.systolic',
                                  model     = 'Systolic BP')
## O2 Saturation (Categorised)
logistic$o2.saturation.cat <- dipep_glm(df = dipep,
                                        predictor = 'o2.saturation.cat',
                                        model = 'O2 Saturation (Binary)')
## O2 Saturation
logistic$o2.saturation <- dipep_glm(df = dipep,
                                    predictor = 'o2.saturation',
                                    model = 'O2 Saturation')
## Respiratory Rate (Categorised)
logistic$respiratory.rate.cat <- dipep_glm(df = dipep,
                                           predictor = 'respiratory.rate.cat',
                                           model = 'Respiratory Rate (Binary)')
## Respiratory Rate
logistic$respiratory.rate <- dipep_glm(df = dipep,
                                       predictor = 'respiratory.rate',
                                       model = 'Respiratory Rate')
## Heart Rate (Categorised)
logistic$heart.rate.cat <- dipep_glm(df = dipep,
                                     predictor = 'heart.rate.cat',
                                     model = 'Heart Rate (Binary)')
## Heart Rate
logistic$heart.rate <- dipep_glm(df = dipep,
                                 predictor = 'heart.rate',
                                 model = 'Heart Rate')
## BMI (Categorised)
logistic$bmi.cat <- dipep_glm(df = dipep,
                              predictor = 'bmi.cat',
                              model = 'BMI (Binary)')
## BMI
logistic$bmi <- dipep_glm(df = dipep,
                          predictor = 'bmi',
                          model = 'BMI')
## Previous Pregnancies < 24 weeks
logistic$pregnancies.under <- dipep_glm(df = dipep,
                                        predictor = 'pregnancies.under',
                                        model = 'Pregnancies <= 24')
## Previous Pregnancies > 24 weeks
logistic$pregnancies.over <- dipep_glm(df = dipep,
                                       predictor = 'pregnancies.over',
                                       model = 'Pregnancies >= 24')
## Previous Pregnancy Problems
logistic$prev.preg.problem <- dipep_glm(df = dipep,
                                        predictor = 'prev.preg.problem',
                                        model = 'Previous Pregnancy Problems')
## Pleuritic
logistic$presenting.features.pleuritic <- dipep_glm(df = dipep,
                                                    predictor = 'presenting.features.pleuritic',
                                                    model = 'Pleuritic')
## Non-Pleuritic
logistic$presenting.features.non.pleuritic <- dipep_glm(df = dipep,
                                                        predictor = 'presenting.features.non.pleuritic',
                                                        model = 'Non-Pleuritic')
## Shortness of Breath (Exertion)
logistic$presenting.features.sob.exertion <- dipep_glm(df = dipep,
                                                       predictor = 'presenting.features.sob.exertion',
                                                       model = 'Shortness of Breath (Exertion)')
## Shortness of Breath (Rest)
logistic$presenting.features.sob.rest <- dipep_glm(df = dipep,
                                                   predictor = 'presenting.features.sob.rest',
                                                   model = 'Shortness of Breath (Rest)')
## Haemoptysis
logistic$presenting.features.haemoptysis <- dipep_glm(df = dipep,
                                                      predictor = 'presenting.features.haemoptysis',
                                                      model = 'Haemoptysis')
## Cough
logistic$presenting.features.cough <- dipep_glm(df = dipep,
                                                predictor = 'presenting.features.cough',
                                                model = 'Cough')
## Syncope
logistic$presenting.features.syncope <- dipep_glm(df = dipep,
                                                  predictor = 'presenting.features.syncope',
                                                  model = 'Syncope')
## Palpitations
logistic$presenting.features.palpitations <- dipep_glm(df = dipep,
                                                       predictor = 'presenting.features.palpitations',
                                                       model = 'Palpitations')
## Other Features on Presentation
logistic$presenting.features.other <- dipep_glm(df = dipep,
                                                predictor = 'presenting.features.other',
                                                model = 'Other')
## Surgery
logistic$surgery <- dipep_glm(df = dipep,
                              predictor = 'surgery',
                              model = 'Surgery')
## Family history of thrombosis
logistic$history.thrombosis <- dipep_glm(df = dipep,
                                         predictor = 'history.thrombosis',
                                         model = 'Family History of Thrombosis')
## History of varicoseveins
logistic$history.veins <- dipep_glm(df = dipep,
                                    predictor = 'history.veins',
                                    model =  'Varicose Veins')
## History of IV Drug use
logistic$history.iv.drug <- dipep_glm(df = dipep,
                                      predictor = 'history.iv.drug',
                                      model = 'History of IV Drug Use')
## Thrombosis
logistic$thrombosis <- dipep_glm(df = dipep,
                                 predictor = 'thrombosis',
                                 model = 'History of Thrombosis')
## Trimester
logistic$trimester <- dipep_glm(df = dipep,
                                predictor = 'trimester',
                                model = 'Trimester')
## Problems with this pregnancy
logistic$this.pregnancy.problems <- dipep_glm(df = dipep,
                                              predictor = 'this.pregnancy.problems',
                                              model = 'Problems During This Pregnancy')
## Thrombo
logistic$thrombo <- dipep_glm(df = dipep,
                              predictor = 'thrombo',
                              model = 'Known Thrombophilia')
## Multiple Pregnancy
logistic$multiple.preg <- dipep_glm(df = dipep,
                                    predictor = 'multiple.preg',
                                    model = 'Multiple Pregnancy')
## Travel
logistic$travel <- dipep_glm(df = dipep,
                             predictor = 'travel',
                             model = 'Long-haul travel during pregnancy')
## Immobility
logistic$immobil <- dipep_glm(df = dipep,
                              predictor = 'immobil',
                              model = '>=3 days Immobility/bed rest during pregnancy')
## ECG (Categorised)
logistic$ecg.cat <- dipep_glm(df = dipep,
                              predictor = 'ecg.cat',
                              model = 'ECG (Binary)')
## ECG
logistic$ecg <- dipep_glm(df = dipep,
                          predictor = 'ecg',
                          model = 'ECG')
## ECG (Categorised)
logistic$xray.cat <- dipep_glm(df = dipep,
                               predictor = 'xray.cat',
                               model = 'X-Ray (Binary)')
## X-Ray
logistic$xray <- dipep_glm(df = dipep,
                           predictor = 'xray',
                           model = 'X-Ray')
## X-Ray (Categorised)
logistic$xray.cat <- dipep_glm(df = dipep,
                               predictor = 'xray.cat',
                               model = 'X-Ray (Binary)')


## Combine all three sets of tidied output from each model
logistic$tidied <- rbind(logistic$age$tidied,
                         logistic$age.cat$tidied,
                         logistic$smoking$tidied,
                         logistic$temperature.cat$tidied,
                         logistic$temperature$tidied,
                         logistic$bp.diastolic.cat$tidied,
                         logistic$bp.diastolic$tidied,
                         ## logistic$bp.systolic.cat$tidied,
                         logistic$bp.systolic$tidied,
                         logistic$o2.saturation.cat$tidied,
                         logistic$o2.saturation$tidied,
                         logistic$respiratory.rate.cat$tidied,
                         logistic$respiratory.rate$tidied,
                         logistic$heart.rate.cat$tidied,
                         logistic$heart.rate$tidied,
                         logistic$bmi.cat$tidied,
                         logistic$bmi$tidied,
                         logistic$pregnancies.under$tidied,
                         logistic$pregnancies.over$tidied,
                         logistic$prev.preg.problem$tidied,
                         logistic$presenting.features.pleuritic$tidied,
                         logistic$presenting.features.non.pleuritic$tidied,
                         logistic$presenting.features.sob.exertion$tidied,
                         logistic$presenting.features.sob.rest$tidied,
                         logistic$presenting.features.haemoptysis$tidied,
                         logistic$presenting.features.cough$tidied,
                         logistic$presenting.features.syncope$tidied,
                         logistic$presenting.features.palpitations$tidied,
                         logistic$presenting.features.other$tidied,
                         logistic$surgery$tidied,
                         logistic$history.thrombosis$tidied,
                         logistic$history.veins$tidied,
                         ## logistic$history.iv.drug$tidied,
                         logistic$thrombosis$tidied,
                         logistic$trimester$tidied,
                         logistic$this.pregnancy.problems$tidied,
                         logistic$thrombo$tidied$tidied,
                         logistic$multiple.preg$tidied,
                         logistic$travel$tidied,
                         logistic$immobil$tidied,
                         logistic$ecg.cat$tidied,
                         logistic$ecg$tidied,
                         logistic$xray.cat$tidied,
                         logistic$xray$tidied) %>%
                    mutate(lower = estimate - 1.96 * std.error,
                           upper = estimate + 1.96 * std.error)
logistic$glance <- rbind(logistic$age$glance,
                         logistic$smoking$glance,
                         logistic$temperature.cat$glance,
                         logistic$temperature$glance,
                         logistic$bp.diastolic.cat$glance,
                         logistic$bp.diastolic$glance,
                         ## logistic$bp.systolic.cat$glance,
                         logistic$bp.systolic$glance,
                         logistic$o2.saturation.cat$glance,
                         logistic$o2.saturation$glance,
                         logistic$respiratory.rate.cat$glance,
                         logistic$respiratory.rate$glance,
                         logistic$heart.rate.cat$glance,
                         logistic$heart.rate$glance,
                         logistic$bmi.cat$glance,
                         logistic$bmi$glance,
                         logistic$pregnancies.under$glance,
                         logistic$pregnancies.over$glance,
                         logistic$prev.preg.problem$glance,
                         logistic$presenting.features.pleuritic$glance,
                         logistic$presenting.features.non.pleuritic$glance,
                         logistic$presenting.features.sob.exertion$glance,
                         logistic$presenting.features.sob.rest$glance,
                         logistic$presenting.features.haemoptysis$glance,
                         logistic$presenting.features.cough$glance,
                         logistic$presenting.features.syncope$glance,
                         logistic$presenting.features.palpitations$glance,
                         logistic$presenting.features.other$glance,
                         logistic$surgery$glance,
                         logistic$history.thrombosis$glance,
                         logistic$history.veins$glance,
                         ## logistic$history.iv.drug$glance,
                         logistic$thrombosis$glance,
                         logistic$trimester$glance,
                         logistic$this.pregnancy.problems$glance,
                         logistic$thrombo$glance$glance,
                         logistic$multiple.preg$glance,
                         logistic$travel$glance,
                         logistic$immobil$glance,
                         logistic$ecg.cat$glance,
                         logistic$ecg$glance,
                         logistic$xray.cat$glance,
                         logistic$xray$glance)

## Combine all predicted
logistic$predicted <- rbind(logistic$age$predicted,
                            logistic$age.cat$predicted,
                            logistic$smoking$predicted,
                            logistic$temperature$predicted,
                            logistic$temperature.cat$predicted,
                            logistic$bp.diastolic$predicted,
                            logistic$bp.diastolic.cat$predicted,
                            logistic$bp.systolic$predicted,
                            ## logistic$bp.systolic.cat$predicted,
                            logistic$o2.saturation$predicted,
                            logistic$o2.saturation.cat$predicted,
                            logistic$respiratory.rate$predicted,
                            logistic$respiratory.rate.cat$predicted,
                            logistic$heart.rate$predicted,
                            logistic$heart.rate.cat$predicted,
                            logistic$bmi$predicted,
                            logistic$bmi.cat$predicted,
                            logistic$pregnancies.under$predicted,
                            logistic$pregnancies.over$predicted,
                            logistic$prev.preg.problem$predicted,
                            logistic$presenting.features.pleuritic$predicted,
                            logistic$presenting.features.non.pleuritic$predicted,
                            logistic$presenting.features.sob.rest$predicted,
                            logistic$presenting.features.sob.exertion$predicted,
                            logistic$presenting.features.haemoptysis$predicted,
                            logistic$presenting.features.cough$predicted,
                            logistic$presenting.features.syncope$predicted,
                            logistic$presenting.features.palpitations$predicted,
                            logistic$presenting.features.other$predicted,
                            logistic$surgery$predicted,
                            logistic$history.thrombosis$predicted,
                            logistic$history.veins$predicted,
                            ## logistic$history.iv.drug$predicted,
                            logistic$thrombosis$predicted,
                            logistic$trimester$predicted,
                            logistic$this.pregnancy.problems$predicted,
                            logistic$thrombo$predicted,
                            logistic$multiple.preg$predicted,
                            logistic$travel$predicted,
                            logistic$immobil$predicted,
                            logistic$ecg.cat$predicted,
                            logistic$ecg$predicted,
                            logistic$xray.cat$predicted,
                            logistic$xray$predicted)
## Remove 'presenting.features.' from name
logistic$predicted <- mutate(logistic$predicted,
                             name = gsub('presenting.features.', '', name))

## Saturated
logistic$saturated <- dipep_glm(df = dipep,
                                predictor = c('age', 'bmi', 'temperature', 'bp.diastolic', 'bp.systolic',
                                              'o2.saturation', 'respiratory.rate', 'heart.rate', 'smoking',
                                              'prev.preg.problem', 'pregnancies.under', 'pregnancies.over',
                                              'presenting.features.pleuritic', 'presenting.features.non.pleuritic',
                                              'presenting.features.sob.rest', 'presenting.features.sob.exertion',
                                              'presenting.features.cough', 'presenting.features.haemoptysis',
                                              'presenting.features.syncope', 'presenting.features.palpitations',
                                              'presenting.features.other', 'surgery',
                                              'history.thrombosis', 'history.veins', ## 'history.iv.drug',
                                              'thrombosis', 'trimester', 'this.pregnancy.problems',
                                              'thrombo', 'multiple.preg', 'travel', 'immobil',
                                              'ecg', 'xray'),
                                model = 'Saturated Multivariable Logistic Model')


```

#### Univariable Regression
Its is not advisable to use the results of univariable regression to shape your choice of variables to include in multi-variable models for the simple reason that the coefficients obtained for a variable in isolation will not be the same as those from a multi-variable model.  Thus something that appears to be significant under univariable analysis may well not be under multi-variable analysis.  A better strategy is to use expert clinical knowledge as to what factors are important to determine which variables are included in a multi-variable model.

Regardless each of the individual variables has been analysed under a univariable logistic regression model.  The coefficients, their confidence intervals, the sensitivity, specificity and area under the receiver operating characeristics curve are tabulated below.  For the full output of each univariable logistic regression model please refer to the [Appendix](dipep.html#appendix).


##### Point Estimates

The point-estimate and 95% Confidence Intervals from univariable logistic regression are plotted and tabulated below.  Both raw continuous and categorised variables are included to provide comparison.

```{r results_logistic_regression_summary, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
to.sum <- dplyr::filter(logistic$tidied, term != '(Intercept)') %>%
          ## Remove temperature and O2 Saturation as CI is HUGE
          dplyr::filter(term != 'Temperature (High)') %>%
          dplyr::filter(term != 'O2 Saturation (High)') %>%
          dplyr::select(term, estimate, lower, upper, p.value)
ggplot(to.sum, aes(term, estimate, colour = term)) +
    geom_point() + geom_errorbar(aes(ymin = lower, ymax = upper)) +
    coord_flip() + geom_hline(yintercept = 0) +
    xlab('Predictor') + ylab('Estimate') +
    ggtitle('Point Estimate and 95% CI for Univariable Logistic Regression') +
    theme_bw() + theme(legend.position = 'none')
## Redo subsetting, include temperature and O2 Saturation
to.sum <- dplyr::filter(logistic$tidied, term != '(Intercept)') %>%
          dplyr::select(term, estimate, lower, upper, p.value)
names(to.sum) <- c('Term', 'Estimate', 'Lower CI', 'Upper CI', 'P-Value')
kable(to.sum,
      caption = 'Point estimates, 95% CIs and p-values for Univariable Regression')
rm(to.sum)

```

##### ROC Curves

[Sensitivity and Specificity](https://en.wikipedia.org/wiki/Sensitivity_and_specificity) are not absolute since each individual is assigned a probability from the logistic regression model and it is then down to the investigator to decide what threshold ($0 < x < 1$ if not exponentiated) should be used to classify someone as having a Pulmonary Embolism.  A simple way of visualising the sensitivity and specificity for different thresholds is via a [Receiver Operating Characteristic Curve](https://en.wikipedia.org/wiki/Receiver_operating_characteristic) which plots the [false-positive rate](https://en.wikipedia.org/wiki/False_positive_rate) against the true positive rate.  The following graph shows the curves for the different univariable logistic regression models.

```{r results_logistic_regression_roc, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
## This uses the geom_roc() ggplot2 extension from the ploROC package
## ROC for continuous variables
ggplot(dplyr::filter(logistic$predicted, name %in% c('age',
                                                     'bmi',
                                                     'o2.saturation',
                                                     'bp.diastolic',
                                                     'bp.systolic',
                                                     'temperature',
                                                     'ecg')),
       aes(d = D, m = M, colour = term)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Continuous Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot categorised variables
ggplot(dplyr::filter(logistic$predicted, name %in% c('age.cat',
                                                     'bmi.cat',
                                                     'o2.saturation.cat',
                                                     'bp.diastolic.cat',
                                                     'bp.systolic.cat',
                                                     'temperature.cat',
                                                     'ecg.cat')),
       aes(d = D, m = M, color = term)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Binary Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot presenting features
ggplot(dplyr::filter(logistic$predicted, name %in% c('pleuritic',
                                          'non.pleuritic',
                                          'sob.exertion',
                                          'sob.rest',
                                          'cough',
                                          'haemoptysis',
                                          'syncope',
                                          'palpitations',
                                          'other')),
       aes(d = D, m = M, color = term)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Presenting Features Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot Other
ggplot(dplyr::filter(logistic$predicted, name %in% c('prev.preg.problem',
                                          'pregnancies.over',
                                          'pregnancies.under',
                                          'xray.cat',
                                          'this.pregnancy.problems')),
       aes(d = D, m = M, color = term)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Presenting Features Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot Medical History
ggplot(dplyr::filter(logistic$predicted, name %in% c('history.thrombosis',
                                          'history.iv.drug',
                                          'history.veins',
                                          'thrombo',
                                          'surgery',
                                          'thrombosis')),
       aes(d = D, m = M, color = name)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Medical History Univariable Logistic Regression') +
    style_roc() + theme_bw()

```

#### Saturated Regression

In a situation where you are likely to have information on all possible variables to hand it makes little sense in disregarding some of that information even if it only improves the overall fit of a model by a small fraction.  To this end a saturated logistic regression model including all variables in their raw, uncategroised format (which preserves the maximum amount of information) has been tested for its performance.

```{r results_logistic_regression_multi_summary, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
to.sum <- mutate(logistic$saturated$tidied,
                 lower = estimate - 1.96 * std.error,
                 upper = estimate + 1.96 * std.error) %>%
          dplyr::select(term, estimate, lower, upper, p.value) %>%
          dplyr::filter(term != '(Intercept)')
ggplot(to.sum, aes(term, estimate, colour = term)) +
    geom_point() + geom_errorbar(aes(ymin = lower, ymax = upper)) +
    coord_flip() + geom_hline(yintercept = 0) +
    xlab('Predictor') + ylab('Estimate') +
    ggtitle('Point Estimate and 95% CI for Univariable Logistic Regression') +
    theme_bw() + theme(legend.position = 'none')
names(to.sum) <- c('Term', 'Estimate', 'Lower CI', 'Upper CI', 'P-Value')
kable(to.sum,
      caption = 'Point estimates, 95% CIs and p-values for Univariable Regression')
rm(to.sum)

```

```{r results_logistic_regression_multi_roc, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
logistic$saturated$roc
```
