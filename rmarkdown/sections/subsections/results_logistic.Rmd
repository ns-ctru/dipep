```{r results_logistic_regression, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
## Test each outcome for association, then gather them *using broom) into one dataset for summarisation
## Age
logistic.age <- dipep_glm(df = dipep,
                          predictor = 'age')
## Age (Categorised)
logistic.age.cat <- dipep_glm(df = dipep,
                          predictor = 'age.cat')
## Smoking
logistic.smoking <- dipep_glm(df = dipep,
                          predictor = 'smoking')
## Temperature (Categorised)
logistic.temperature.cat <- dipep_glm(df = dipep,
                          predictor = 'temperature.cat')
## Temperature
logistic.temperature <- dipep_glm(df = dipep,
                          predictor = 'temperature')
## BP Diastolic (Categorised)
logistic.bp.diastolic.cat <- dipep_glm(df = dipep,
                          predictor = 'bp.diastolic.cat')
## BP Diastolic
logistic.bp.diastolic <- dipep_glm(df = dipep,
                          predictor = 'bp.diastolic')
## BP Systolic (Categorised)
## logistic.bp.systolic.cat <- dipep_glm(df = dipep,
##                           predictor = 'bp.systolic.cat')
## BP Systolic
logistic.bp.systolic <- dipep_glm(df = dipep,
                          predictor = 'bp.systolic')
## O2 Saturation (Categorised)
logistic.o2.saturation.cat <- dipep_glm(df = dipep,
                          predictor = 'o2.saturation.cat')
## O2 Saturation
logistic.o2.saturation <- dipep_glm(df = dipep,
                          predictor = 'o2.saturation')
## Respiratory Rate (Categorised)
logistic.respiratory.rate.cat <- dipep_glm(df = dipep,
                          predictor = 'respiratory.rate.cat')
## Respiratory Rate
logistic.respiratory.rate <- dipep_glm(df = dipep,
                          predictor = 'respiratory.rate')
## BMI (Categorised)
logistic.bmi.cat <- dipep_glm(df = dipep,
                          predictor = 'bmi.cat')
## BMI
logistic.bmi <- dipep_glm(df = dipep,
                          predictor = 'bmi')
## Previous Pregnancies < 24 weeks
logistic.pregnancies.under <- dipep_glm(df = dipep,
                          predictor = 'pregnancies.under')
## Previous Pregnancies > 24 weeks
logistic.pregnancies.over <- dipep_glm(df = dipep,
                          predictor = 'pregnancies.over')
## Previous Pregnancy Problems
logistic.prev.preg.problem <- dipep_glm(df = dipep,
                             predictor = 'prev.preg.problem')
## For now fill in missing, will switch to using 'imputed' data set later
dipep <- mutate(dipep,
                presenting.features.pleuritic = ifelse(is.na(presenting.features.pleuritic),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.pleuritic),
                presenting.features.non.pleuritic = ifelse(is.na(presenting.features.non.pleuritic),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.non.pleuritic),
                presenting.features.sob.exertion = ifelse(is.na(presenting.features.sob.exertion),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.sob.exertion),
                presenting.features.sob.rest = ifelse(is.na(presenting.features.sob.rest),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.sob.rest),
                presenting.features.haemoptysis = ifelse(is.na(presenting.features.haemoptysis),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.haemoptysis),
                presenting.features.cough = ifelse(is.na(presenting.features.cough),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.cough),
                presenting.features.syncope = ifelse(is.na(presenting.features.syncope),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.syncope),
                presenting.features.palpitations = ifelse(is.na(presenting.features.palpitations),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.palpitations),
                presenting.features.other = ifelse(is.na(presenting.features.other),
                                                       yes = 'Not Ticked',
                                                       no  = presenting.features.other))
## Pleuritic
logistic.presenting.features.pleuritic <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.pleuritic')
## Non-Pleuritic
logistic.presenting.features.non.pleuritic <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.non.pleuritic')
## Shortness of Breath (Exertion)
logistic.presenting.features.sob.exertion <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.sob.exertion')
## Shortness of Breath (Rest)
logistic.presenting.features.sob.rest <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.sob.rest')
## Haemoptysis
logistic.presenting.features.haemoptysis <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.haemoptysis')
## Cough
logistic.presenting.features.cough <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.cough')
## Syncope
logistic.presenting.features.syncope <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.syncope')
## Palpitations
logistic.presenting.features.palpitations <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.palpitations')
## Other Features on Presentation
logistic.presenting.features.other <- dipep_glm(df = dipep,
                          predictor = 'presenting.features.other')

## Combine all three sets of tidied output from each model
logistic.tidied <- rbind(logistic.age$tidied,
                         logistic.age.cat$tidied,
                         logistic.smoking$tidied,
                         logistic.temperature.cat$tidied,
                         logistic.temperature$tidied,
                         logistic.bp.diastolic.cat$tidied,
                         logistic.bp.diastolic$tidied,
                         ## logistic.bp.systolic.cat$tidied,
                         logistic.bp.systolic$tidied,
                         logistic.o2.saturation.cat$tidied,
                         logistic.o2.saturation$tidied,
                         logistic.respiratory.rate.cat$tidied,
                         logistic.respiratory.rate$tidied,
                         logistic.bmi.cat$tidied,
                         logistic.bmi$tidied,
                         logistic.pregnancies.under$tidied,
                         logistic.pregnancies.over$tidied,
                         logistic.prev.preg.problem$tidied,
                         logistic.presenting.features.pleuritic$tidied,
                         logistic.presenting.features.non.pleuritic$tidied,
                         logistic.presenting.features.sob.exertion$tidied,
                         logistic.presenting.features.sob.rest$tidied,
                         logistic.presenting.features.haemoptysis$tidied,
                         logistic.presenting.features.cough$tidied,
                         logistic.presenting.features.syncope$tidied,
                         logistic.presenting.features.palpitations$tidied,
                         logistic.presenting.features.other$tidied) %>%
                    ## mutate(term = gsub('age.catOld', 'Age (Old)', term),
                    ##        term = gsub('smokinggave up prior to pregnancy', 'Ex-smoker (Prior)', term),
                    ##        term = gsub('smokinggave up during pregnancy', 'Ex-smoker (During)', term),
                    ##        term = gsub('smokingcurrent', 'Current Smoker', term),
                    ##        term = gsub('temperature.catHigh', 'Temperature (High)', term),
                    ##        term = gsub('bp.diastolic.catHigh', 'Diastolic (High)', term),
                    ##        term = gsub('bp.systolic.catHigh', 'Systolic (High)', term),
                    ##        term = gsub('o2.saturation.catHigh', 'O2 Saturation (High)', term),
                    ##        term = gsub('respiratory.rate.catHigh', 'Respiratory Rate (High)', term),
                    ##        term = gsub('bmi.catHigh', 'BMI (High)', term),
                    ##        term = gsub('Ticked', '', term),
                    ##        ## term = gsub('.cat', ' (Categorised)', term),
                    ##        term = gsub('age', 'Age (Continuous)', term),
                    ##        term = gsub('bp.diastolic', 'Diastolic (Continuous)', term),
                    ##        term = gsub('bp.systolic', 'Systolic (Continuous)', term),
                    ##        term = gsub('o2.saturation', 'O2 Saturation (Continuous)', term),
                    ##        term = gsub('bmi', 'BMI (Continuous)', term),
                    ##        term = gsub('presenting.features.pleuriticNot ', 'Presenting : Pleuritic', term),
                    ##        term = gsub('presenting.features.non.pleuriticNot ', 'Presenting : Non-Pleuritic', term),
                    ##        term = gsub('presenting.features.sob.exertionNot ', 'Presenting : Shortness of Breath (Exertion)', term),
                    ##        term = gsub('presenting.features.sob.rest', 'Presenting : Shortness of Breath (Rest)', term),
                    ##        term = gsub('presenting.features.haemoptysis', 'Presenting : Haemoptysis', term),
                    ##        term = gsub('presenting.features.cough', 'Presenting : Cough', term),
                    ##        term = gsub('presenting.features.syncope', 'Presenting : Syncope', term),
                    ##        term = gsub('presenting.features.palpitations', 'Presenting : Palpitations', term),
                    ##        term = gsub('presenting.features.other', 'Presenting : Other', term),
                    ##        term = gsub('preganancies.under', 'Pregnancies < 24 weeks', term),
                    ##        term = gsub('preganancies.over', 'Pregnancies > 24 weeks', term),
                    ##        term = gsub('prev.preg.problemNo', 'No Previous Pregnancy Problems', term) %>%
                    mutate(lower = estimate - 1.96 * std.error,
                           upper = estimate + 1.96 * std.error)
logistic.glance <- rbind(logistic.age$glance,
                         logistic.smoking$glance,
                         logistic.temperature.cat$glance,
                         logistic.temperature$glance,
                         logistic.bp.diastolic.cat$glance,
                         logistic.bp.diastolic$glance,
                         ## logistic.bp.systolic.cat$glance,
                         logistic.bp.systolic$glance,
                         logistic.o2.saturation.cat$glance,
                         logistic.o2.saturation$glance,
                         logistic.respiratory.rate.cat$glance,
                         logistic.respiratory.rate$glance,
                         logistic.bmi.cat$glance,
                         logistic.bmi$glance,
                         logistic.pregnancies.under$glance,
                         logistic.pregnancies.over$glance,
                         logistic.prev.preg.problem$glance,
                         logistic.presenting.features.pleuritic$glance,
                         logistic.presenting.features.non.pleuritic$glance,
                         logistic.presenting.features.sob.exertion$glance,
                         logistic.presenting.features.sob.rest$glance,
                         logistic.presenting.features.haemoptysis$glance,
                         logistic.presenting.features.cough$glance,
                         logistic.presenting.features.syncope$glance,
                         logistic.presenting.features.palpitations$glance,
                         logistic.presenting.features.other$glance)

## Get all predicted values
logistic.predicted <- merge(logistic.age$predicted,
                            logistic.age.cat$predicted,
                            by  = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.smoking$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.temperature$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.temperature.cat$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.bp.diastolic$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.bp.diastolic.cat$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.bp.systolic$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      ## merge(.,
                      ##       logistic.bp.systolic.cat$predicted,
                      ##       by = 'obs',
                      ##       all = TRUE) %>%
                      merge(.,
                            logistic.o2.saturation$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.o2.saturation.cat$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.respiratory.rate$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.respiratory.rate.cat$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.bmi$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.bmi.cat$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.pregnancies.under$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.pregnancies.over$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.prev.preg.problem$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.pleuritic$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.non.pleuritic$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.sob.rest$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.sob.exertion$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.haemoptysis$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.cough$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.syncope$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.palpitations$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      merge(.,
                            logistic.presenting.features.other$predicted,
                            by = 'obs',
                            all = TRUE) %>%
                      ## Age is complete, use observed values from that, remove all others
                      dplyr::select(pe.age, pred.age, pred.age.cat, pred.smoking,
                                    pred.temperature, pred.temperature.cat,
                                    pred.bp.diastolic, pred.bp.diastolic.cat,
                                    pred.bp.systolic, ## pred.bp.systolic.cat,
                                    pred.o2.saturation, pred.o2.saturation.cat,
                                    pred.respiratory.rate, pred.respiratory.rate.cat,
                                    pred.bmi, pred.bmi.cat, pred.prev.preg.problem,
                                    pred.pregnancies.under, pred.pregnancies.over,
                                    pred.presenting.features.pleuritic, pred.presenting.features.non.pleuritic,
                                    pred.presenting.features.sob.rest, pred.presenting.features.sob.exertion,
                                    pred.presenting.features.cough, pred.presenting.features.haemoptysis,
                                    pred.presenting.features.syncope, pred.presenting.features.palpitations,
                                    pred.presenting.features.other)
## Sort out names
names(logistic.predicted) <- gsub('pe.age', 'pe', names(logistic.predicted))
names(logistic.predicted) <- gsub('pred.', '', names(logistic.predicted))

## Saturated
saturated <- dipep_glm(df = dipep,
                       predictor = c('age', 'bmi', 'temperature', 'bp.diastolic', 'bp.systolic', 'o2.saturation', 'respiratory.rate',
                                     'smoking', 'prev.preg.problem', 'pregnancies.under', 'pregnancies.over',
                                     'presenting.features.pleuritic', 'presenting.features.non.pleuritic',
                                     'presenting.features.sob.rest', 'presenting.features.sob.exertion',
                                     'presenting.features.cough', 'presenting.features.haemoptysis',
                                     'presenting.features.syncope', 'presenting.features.palpitations',
                                     'presenting.features.other'),
                       model = 'saturated multivariable logistic model')


```

#### Univariable Regression
Its is not advisable to use the results of univariable regression to shape your choice of variables to include in multi-variable models for the simple reason that the coefficients obtained for a variable in isolation will not be the same as those from a multi-variable model.  Thus something that appears to be significant under univariable analysis may well not be under multi-variable analysis.  A better strategy is to use expert clinical knowledge as to what factors are important to determine which variables are included in a multi-variable model.

Regardless each of the individual variables has been analysed under a univariable logistic regression model.  The coefficients, their confidence intervals, the sensitivity, specificity and area under the receiver operating characeristics curve are tabulated below.


##### Point Estimates

The point-estimate and 95% Confidence Intervals from univariable logistic regression are plotted and tabulated below.  Both raw continuous and categorised variables are included to provide comparison.

```{r results_logistic_regression_summary, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
to.sum <- dplyr::filter(logistic.tidied, term != '(Intercept)') %>%
    dplyr::select(term, estimate, lower, upper, p.value)
ggplot(to.sum, aes(term, estimate, colour = term)) +
    geom_point() + geom_errorbar(aes(ymin = lower, ymax = upper)) +
    coord_flip() + geom_hline(yintercept = 0) +
    xlab('Predictor') + ylab('Estimate') +
    ggtitle('Point Estimate and 95% CI for Univariable Logistic Regression') +
    theme_bw() + theme(legend.position = 'none')
names(to.sum) <- c('Term', 'Estimate', 'Lower CI', 'Upper CI', 'P-Value')
kable(to.sum,
      caption = 'Point estimates, 95% CIs and p-values for Univariable Regression')
rm(to.sum)

```
##### ROC Curves

[Sensitivity and Specificity](https://en.wikipedia.org/wiki/Sensitivity_and_specificity) are not absolute since each individual is assigned a probability from the logistic regression model and it is then down to the investigator to decide what threshold ($0 < x < 1$ if not exponentiated) should be used to classify someone as having a Pulmonary Embolism.  A simple way of visualising the sensitivity and specificity for different thresholds is via a [Receiver Operating Characteristic Curve](https://en.wikipedia.org/wiki/Receiver_operating_characteristic) which plots the [false-positive rate](https://en.wikipedia.org/wiki/False_positive_rate) against the true positive rate.  The following graph shows the curves for the different univariable logistic regression models.

```{r results_logistic_regression_roc, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
## This uses the geom_roc() ggplot2 extension from the ploROC package
markers <- names(logistic.predicted)[2:length(names(logistic.predicted))]
to.plot <- melt_roc(logistic.predicted, d = 'pe', m = markers)
to.plot <- mutate(to.plot,
                  name = gsub('presenting.features.', '', name))
## names(to.plot) <- gsub('name', 'Predictor', names(to.plot)
## ROC for continuous variables
ggplot(dplyr::filter(to.plot, name %in% c('age', 'bmi', 'o2.saturation', 'bp.diastolic', 'bp.systolic', 'temperature')),
       aes(d = D, m = M, color = name)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Continuous Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot categorised variables
ggplot(dplyr::filter(to.plot, name %in% c('age.cat', 'bmi.cat', 'o2.saturation.cat', 'bp.diastolic.cat', 'bp.systolic.cat', 'temperature.cat')),
       aes(d = D, m = M, color = name)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Binary Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot presenting features
ggplot(dplyr::filter(to.plot, name %in% c('pleuritic',
                                          'non.pleuritic',
                                          'sob.exertion',
                                          'sob.rest',
                                          'cough',
                                          'haemoptysis',
                                          'syncope',
                                          'palpitations',
                                          'other')),
       aes(d = D, m = M, color = name)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Presenting Features Univariable Logistic Regression') +
    style_roc() + theme_bw()
## Plot Other
ggplot(dplyr::filter(to.plot, name %in% c('prev.preg.problem',
                                          'pregnancies.over',
                                          'pregnancies.under')),
       aes(d = D, m = M, color = name)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor...')) +
    ggtitle('ROC curves for Presenting Features Univariable Logistic Regression') +
    style_roc() + theme_bw()

```

#### Saturated Regression

In a situation where you are likely to have information on all possible variables to hand it makes little sense in disregarding some of that information even if it only improves the overall fit of a model by a small fraction.  To this end a saturated logistic regression model including all variables in their raw, uncategroised format (which preserves the maximum amount of information) has been tested for its performance.

```{r results_logistic_regression_multi_summary, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
to.sum <- mutate(saturated$tidied,
                 lower = estimate - 1.96 * std.error,
                 upper = estimate + 1.96 * std.error) %>%
          dplyr::select(term, estimate, lower, upper, p.value) %>%
          dplyr::filter(term != '(Intercept)')
ggplot(to.sum, aes(term, estimate, colour = term)) +
    geom_point() + geom_errorbar(aes(ymin = lower, ymax = upper)) +
    coord_flip() + geom_hline(yintercept = 0) +
    xlab('Predictor') + ylab('Estimate') +
    ggtitle('Point Estimate and 95% CI for Univariable Logistic Regression') +
    theme_bw() + theme(legend.position = 'none')
names(to.sum) <- c('Term', 'Estimate', 'Lower CI', 'Upper CI', 'P-Value')
kable(to.sum,
      caption = 'Point estimates, 95% CIs and p-values for Univariable Regression')
rm(to.sum)

```

```{r results_logistic_regression_multi_roc, echo = FALSE, cache = FALSE, results = 'markup', eval = TRUE}
saturated$roc
```
