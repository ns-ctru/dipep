### Existing Scores {.tabset .tabset-fade .tabset-pills}

```{r results_existing_roc, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
to.plot <- dplyr::filter(dipep, !is.na(first.st)) %>%
    ## ToDp 2017-02-23 - Add in Delphi scores
           dplyr::select(pe, simplified.pe, wells.pe, perc.pe) %>%
           tidyr::gather(key = pe)##  %>%
           ## mutate(value = ifelse(grepl('No', value),
           ##                       0,
           ##                       1))

names(to.plot) <- c('D', 'Score', 'value')
## Convert String variable to 0/1 for predicted probabilities
to.plot <- to.plot %>%
           dplyr::mutate(M     = ifelse(grepl('No', value), 0, 1),
                         Score = case_when(.$Score == 'simplified.pe' ~ 'Simplified Revised Geneva',
                                           .$Score == 'perc.pe'       ~ 'PERC',
                                           .$Score == 'wells.pe'      ~ 'Wells'))
ggplot(to.plot, aes(d = D, m = M, colour = Score)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor Score...')) +
    ggtitle('ROC curves for Existing Pulmonary Embolism Predictors') +
    style_roc() + theme_bw()
## Extract the existing scores for Likert style plotting
existing <- dplyr::filter(dipep, !is.na(first.pe)) %>% dplyr::select(group, wells, simplified, perc)

```

#### Simplified Revised Geneva

The Simplified Revised Geneva score(@klok2008) is summarised below.  An [online calculator](https://www.mdcalc.com/geneva-score-revised-pulmonary-embolism) is available.  A score $> X$ is taken as indicative of PE.

```{r results_existing_simplified_revised_geneva, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Bar chart of scores by 'true' Status
ggplot(dplyr::filter(dipep, !is.na(first.pe) & group %in% c('Diagnosed PE', 'Suspected PE'), aes(x = simplified)) +
    geom_bar(aes(fill = first.pe), position = 'dodge') +
    ggtitle('Simplified Revised Geneva Scores by clinical classification') +
    xlab('Simplified Revised Geneva Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.simplified <- dplyr::select(existing, simplified)
names(plot.simplified) <- c('Simplified Revised GENEVA Scores')
likert(plot.simplified, grouping = existing$group) %>%
    plot(centered = 4) + labs(caption = 'Plots are centered on the Risk category (4).\n Percentages indicate the proportion below, within and above this.')
## Table of scores
all <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
       mutate(simplified = as.numeric(simplified)) %>%
       summarise(N      = sum(!is.na(simplified)),
                 Mean   = mean(simplified, na.rm = TRUE),
                 SD     = sd(simplified, na.rm = TRUE),
                 Lower  = quantile(simplified, probs = 0.25, na.rm = TRUE),
                 Median = quantile(simplified, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(simplified, probs = 0.75, na.rm = TRUE),
                 Min    = min(simplified, na.rm = TRUE),
                 Max    = max(simplified, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
            mutate(simplified = as.numeric(simplified)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(simplified)),
                      Mean   = mean(simplified, na.rm = TRUE),
                      SD     = sd(simplified, na.rm = TRUE),
                      Lower  = quantile(simplified, probs = 0.25, na.rm = TRUE),
                      Median = quantile(simplified, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(simplified, probs = 0.75, na.rm = TRUE),
                      Min    = min(simplified, na.rm = TRUE),
                      Max    = max(simplified, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Simplified GENEVA score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)
## Tabulation of Simplified Geneva v 'true' PE status and the sensitivity and specificity
## dplyr::filter(dipep, !is.na(simp.pe)) %>%
##        group_by(pe, simp.pe) %>%
##        tally()

```

```{r results_existing_simplified_revised_geneva_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
summary.simplified <- dipep_existing_sum(df    = dipep,
                                         score = simplified.pe)
kable(summary.simplified$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Simplified Revised Geneva Score.')
kable(summary.simplified$summary.table,
      digits  = 3,
      caption = 'Performance indicators for the Simplified Revised Geneva Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```


#### Wells Score

The Wells Score (@wells2001) is summarised below.  An [online calculator](https://www.mdcalc.com/wells-criteria-pulmonary-embolism) is available.  A score $> X$ is taken as indicative of PE.

```{r results_existing_wells, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Bar Chart of scores
ggplot(dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')), aes(x = factor(wells))) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('Wells Scores by clinical classification') +
    xlab('Wells Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.wells <- dplyr::select(existing, wells)
names(plot.wells) <- c('Wells Scores')
likert(plot.wells, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category (2).\n Percentages indicate the proportion below, within and above this.')
## Summary tables
all <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
       mutate(wells = as.numeric(wells)) %>%
       summarise(N      = sum(!is.na(wells)),
                 Mean   = mean(wells, na.rm = TRUE),
                 SD     = sd(wells, na.rm = TRUE),
                 Lower  = quantile(wells, probs = 0.25, na.rm = TRUE),
                 Median = quantile(wells, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(wells, probs = 0.75, na.rm = TRUE),
                 Min    = min(wells, na.rm = TRUE),
                 Max    = max(wells, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
            mutate(wells = as.numeric(wells)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(wells)),
                      Mean   = mean(wells, na.rm = TRUE),
                      SD     = sd(wells, na.rm = TRUE),
                      Lower  = quantile(wells, probs = 0.25, na.rm = TRUE),
                      Median = quantile(wells, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(wells, probs = 0.75, na.rm = TRUE),
                      Min    = min(wells, na.rm = TRUE),
                      Max    = max(wells, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Wells score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)
## Quick model
## .formula <- reformulate(response = 'pe',
##                         termlabels = c('wells'))
## dplyr::filter(dipep, group == 'Suspected PE') %>%
##     glm(formula = .formula,
##         family  = 'binomial')

```

```{r results_existing_wells_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
summary.wells <- dipep_existing_sum(df    = dipep,
                                         score = wells.pe)
kable(summary.wells$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Wells Score.')
kable(summary.wells$summary.table,
      digits = 3,
      caption = 'Performance indicators for the Wells Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

#### PERC Score

The PERC Score for study participants (@kline2004) is summarised below.  It should be noted that the PERC score is designed to be used when a diagnosis of PE is being considered but the risk is low (as described in the [online calculator](http://www.mdcalc.com/perc-rule-pulmonary-embolism/)).  A PERC Score $> 2$ (Moderate Risk) is taken as indicative of PE.

```{r results_existing_perc, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
ggplot(dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')), aes(x = perc)) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('PERC Scores by clinical classification') +
    xlab('PERC Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.perc <- dplyr::select(existing, perc)
names(plot.perc) <- c('PERC Scores')
likert(plot.perc, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category.\n Percentages indicate the proportion below, within and above this.')
## Summary Tables
all <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
       mutate(perc = as.numeric(perc)) %>%
       summarise(N      = sum(!is.na(perc)),
                 Mean   = mean(perc, na.rm = TRUE),
                 SD     = sd(perc, na.rm = TRUE),
                 Lower  = quantile(perc, probs = 0.25, na.rm = TRUE),
                 Median = quantile(perc, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(perc, probs = 0.75, na.rm = TRUE),
                 Min    = min(perc, na.rm = TRUE),
                 Max    = max(perc, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
            mutate(perc = as.numeric(perc)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(perc)),
                      Mean   = mean(perc, na.rm = TRUE),
                      SD     = sd(perc, na.rm = TRUE),
                      Lower  = quantile(perc, probs = 0.25, na.rm = TRUE),
                      Median = quantile(perc, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(perc, probs = 0.75, na.rm = TRUE),
                      Min    = min(perc, na.rm = TRUE),
                      Max    = max(perc, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of PERC score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)

```

```{r results_existing_perc_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
summary.perc <- dipep_existing_sum(df    = dipep,
                                         score = perc.pe)
kable(summary.perc$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on PERC Score.')
kable(summary.perc$summary.table,
      digits = 3,
      caption = 'Performance indicators for the PERC Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

#### Delphi Consensus  {.tabset .tabset-fade .tabset-pills}

The Delphi Consensus panel derived three scores, one overall score (`Primary`), one hoped to maximise sensitivity (`Sensitivity`), and one hoped to maximise specificity (`Specificity`).

##### Primary

```{r results_existing_delphi_primary, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
ggplot(dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')), aes(x = delphi.primary)) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('Delphi (Primary) Scores by clinical classification') +
    xlab('Delphi (Primary) Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.delphi.primary <- dplyr::select(existing, delphi.primary)
names(plot.delphi.primary) <- c('Delphi (Primary) Scores')
likert(plot.delphi.primary, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category.\n Percentages indicate the proportion below, within and above this.')
## Summary Tables
all <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
       mutate(perc = as.numeric(delphi.primary)) %>%
       summarise(N      = sum(!is.na(delphi.primary)),
                 Mean   = mean(delphi.primary, na.rm = TRUE),
                 SD     = sd(delphi.primary, na.rm = TRUE),
                 Lower  = quantile(delphi.primary, probs = 0.25, na.rm = TRUE),
                 Median = quantile(delphi.primary, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(delphi.primary, probs = 0.75, na.rm = TRUE),
                 Min    = min(delphi.primary, na.rm = TRUE),
                 Max    = max(delphi.primary, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
            mutate(delphi.primary = as.numeric(delphi.primary)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(delphi.primary)),
                      Mean   = mean(delphi.primary, na.rm = TRUE),
                      SD     = sd(delphi.primary, na.rm = TRUE),
                      Lower  = quantile(delphi.primary, probs = 0.25, na.rm = TRUE),
                      Median = quantile(delphi.primary, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(delphi.primary, probs = 0.75, na.rm = TRUE),
                      Min    = min(delphi.primary, na.rm = TRUE),
                      Max    = max(delphi.primary, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Delphi (Primary) score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)

```

```{r results_existing_delphi_primary_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
summary.delphi.primary <- dipep_existing_sum(df    = dipep,
                                             score = delphi.primary.pe)
kable(summary.delphi.primary$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Delphi (Primary) Score.')
kable(summary.delphi.primary$summary.table,
      digits = 3,
      caption = 'Performance indicators for the Delphi (Primary) Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

##### Sensitivity

```{r results_existing_delphi_sensitivity, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
ggplot(dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')), aes(x = delphi.sensitivity)) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('Delphi (Sensitivity) Scores by clinical classification') +
    xlab('Delphi (Sensitivity) Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.delphi.sensitivity <- dplyr::select(existing, delphi.sensitivity)
names(plot.delphi.sensitivity) <- c('Delphi (Sensitivity) Scores')
likert(plot.delphi.sensitivity, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category.\n Percentages indicate the proportion below, within and above this.')
## Summary Tables
all <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
       mutate(perc = as.numeric(delphi.sensitivity)) %>%
       summarise(N      = sum(!is.na(delphi.sensitivity)),
                 Mean   = mean(delphi.sensitivity, na.rm = TRUE),
                 SD     = sd(delphi.sensitivity, na.rm = TRUE),
                 Lower  = quantile(delphi.sensitivity, probs = 0.25, na.rm = TRUE),
                 Median = quantile(delphi.sensitivity, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(delphi.sensitivity, probs = 0.75, na.rm = TRUE),
                 Min    = min(delphi.sensitivity, na.rm = TRUE),
                 Max    = max(delphi.sensitivity, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
            mutate(delphi.sensitivity = as.numeric(delphi.sensitivity)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(delphi.sensitivity)),
                      Mean   = mean(delphi.sensitivity, na.rm = TRUE),
                      SD     = sd(delphi.sensitivity, na.rm = TRUE),
                      Lower  = quantile(delphi.sensitivity, probs = 0.25, na.rm = TRUE),
                      Median = quantile(delphi.sensitivity, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(delphi.sensitivity, probs = 0.75, na.rm = TRUE),
                      Min    = min(delphi.sensitivity, na.rm = TRUE),
                      Max    = max(delphi.sensitivity, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Delphi (Sensitivity) score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)

```

```{r results_existing_delphi_sensitivity_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
summary.delphi.sensitivity <- dipep_existing_sum(df    = dipep,
                                             score = delphi.sensitivity.pe)
kable(summary.delphi.sensitivity$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Delphi (Sensitivity) Score.')
kable(summary.delphi.sensitivity$summary.table,
      digits = 3,
      caption = 'Performance indicators for the Delphi (Sensitivity) Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

##### Specificity

```{r results_existing_delphi_specificity, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
ggplot(dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')), aes(x = delphi.specificity)) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('Delphi (Specificity) Scores by clinical classification') +
    xlab('Delphi (Specificity) Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.delphi.specificity <- dplyr::select(existing, delphi.specificity)
names(plot.delphi.specificity) <- c('Delphi (Specificity) Scores')
likert(plot.delphi.specificity, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category.\n Percentages indicate the proportion below, within and above this.')
## Summary Tables
all <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
       mutate(perc = as.numeric(delphi.specificity)) %>%
       summarise(N      = sum(!is.na(delphi.specificity)),
                 Mean   = mean(delphi.specificity, na.rm = TRUE),
                 SD     = sd(delphi.specificity, na.rm = TRUE),
                 Lower  = quantile(delphi.specificity, probs = 0.25, na.rm = TRUE),
                 Median = quantile(delphi.specificity, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(delphi.specificity, probs = 0.75, na.rm = TRUE),
                 Min    = min(delphi.specificity, na.rm = TRUE),
                 Max    = max(delphi.specificity, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
            mutate(delphi.specificity = as.numeric(delphi.specificity)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(delphi.specificity)),
                      Mean   = mean(delphi.specificity, na.rm = TRUE),
                      SD     = sd(delphi.specificity, na.rm = TRUE),
                      Lower  = quantile(delphi.specificity, probs = 0.25, na.rm = TRUE),
                      Median = quantile(delphi.specificity, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(delphi.specificity, probs = 0.75, na.rm = TRUE),
                      Min    = min(delphi.specificity, na.rm = TRUE),
                      Max    = max(delphi.specificity, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Delphi (Specificity) score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)

```

```{r results_existing_delphi_specificity_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
summary.delphi.specificity <- dipep_existing_sum(df    = dipep,
                                             score = delphi.specificity.pe)
kable(summary.delphi.specificity$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Delphi (Specificity) Score.')
kable(summary.delphi.specificity$summary.table,
      digits = 3,
      caption = 'Performance indicators for the Delphi (Specificity) Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```
