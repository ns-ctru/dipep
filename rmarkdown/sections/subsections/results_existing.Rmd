```{r results_existing_roc, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
to.plot <- dplyr::filter(dipep, !is.na(pe)) %>%
           dplyr::select(pe, simplified.pe, wells.pe, perc.pe) %>%
           tidyr::gather(key = pe)##  %>%
           ## mutate(value = ifelse(grepl('No', value),
           ##                       0,
           ##                       1))

names(to.plot) <- c('D', 'Score', 'value')
## Convert String variable to 0/1 for predicted probabilities
to.plot <- to.plot %>%
           dplyr::mutate(M     = ifelse(grepl('No', value), 0, 1),
                         Score = case_when(.$Score == 'simplified.pe' ~ 'Simplified Revised Geneva',
                                           .$Score == 'perc.pe'       ~ 'PERC',
                                           .$Score == 'wells.pe'      ~ 'Wells'))
ggplot(to.plot, aes(d = D, m = M, colour = Score)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor Score...')) +
    ggtitle('ROC curves for Existing Pulmonary Embolism Predictors') +
    style_roc() + theme_bw()
## Extract the existing scores for Likert style plotting
existing <- dplyr::filter(dipep, !is.na(pe)) %>% dplyr::select(group, wells, simplified, perc)

```

#### Simplified Revised Geneva

The Simplified Revised Geneva score(@klok2008) is summarised below.  An [online calculator](https://www.mdcalc.com/geneva-score-revised-pulmonary-embolism) is available.  A score $> X$ is taken as indicative of PE.

```{r results_existing_simplified_revised_geneva, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Bar chart of scores by 'true' PE Status
ggplot(dplyr::filter(dipep, !is.na(pe)), aes(x = simplified)) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('Simplified Revised Geneva Scores by clinical classification') +
    xlab('Simplified Revised Geneva Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.simplified <- dplyr::select(existing, simplified)
names(plot.simplified) <- c('Simplified Revised GENEVA Scores')
likert(plot.simplified, grouping = existing$group) %>%
    plot(centered = 4) + labs(caption = 'Plots are centered on the Risk category (4).\n Percentages indicate the proportion below, within and above this.')
## Table of scores
all <- dplyr::filter(dipep, !is.na(pe)) %>%
       summarise(N      = sum(!is.na(simplified)),
                 Mean   = mean(simplified, na.rm = TRUE),
                 SD     = sd(simplified, na.rm = TRUE),
                 Lower  = quantile(simplified, probs = 0.25, na.rm = TRUE),
                 Median = quantile(simplified, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(simplified, probs = 0.25, na.rm = TRUE),
                 Min    = min(simplified, na.rm = TRUE),
                 Max    = max(simplified, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(simplified)),
                      Mean   = mean(simplified, na.rm = TRUE),
                      SD     = sd(simplified, na.rm = TRUE),
                      Lower  = quantile(simplified, probs = 0.25, na.rm = TRUE),
                      Median = quantile(simplified, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(simplified, probs = 0.25, na.rm = TRUE),
                      Min    = min(simplified, na.rm = TRUE),
                      Max    = max(simplified, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Simplified GENEVA score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)
## Tabulation of Simplified Geneva v 'true' PE status and the sensitivity and specificity
## dplyr::filter(dipep, !is.na(simp.pe)) %>%
##        group_by(pe, simp.pe) %>%
##        tally()

```

```{r results_existing_simplified_revised_geneva_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
summary.simplified <- dipep_existing_sum(df    = dipep,
                                         score = simplified.pe)
kable(summary.simplified$table,
      caption = 'Pulmonary Embolism status compared to predicted status based on Simplified Revised Geneva Score.')
kable(summary.simplified$summary.table,
      caption = 'Performance indicators for the Simplified Revised Geneva Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```


#### Wells Score

The Wells Score (@wells2001) is summarised below.  An [online calculator](https://www.mdcalc.com/wells-criteria-pulmonary-embolism) is available.  A score $> X$ is taken as indicative of PE.

```{r results_existing_wells, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Bar Chart of scores
ggplot(dplyr::filter(dipep, !is.na(pe)), aes(x = factor(wells))) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('Wells Scores by clinical classification') +
    xlab('Wells Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.wells <- dplyr::select(existing, wells)
names(plot.wells) <- c('Wells Scores')
likert(plot.wells, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category (2).\n Percentages indicate the proportion below, within and above this.')
## Summary tables
all <- dplyr::filter(dipep, !is.na(pe)) %>%
       summarise(N      = sum(!is.na(wells)),
                 Mean   = mean(wells, na.rm = TRUE),
                 SD     = sd(wells, na.rm = TRUE),
                 Lower  = quantile(wells, probs = 0.25, na.rm = TRUE),
                 Median = quantile(wells, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(wells, probs = 0.25, na.rm = TRUE),
                 Min    = min(wells, na.rm = TRUE),
                 Max    = max(wells, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(wells)),
                      Mean   = mean(wells, na.rm = TRUE),
                      SD     = sd(wells, na.rm = TRUE),
                      Lower  = quantile(wells, probs = 0.25, na.rm = TRUE),
                      Median = quantile(wells, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(wells, probs = 0.25, na.rm = TRUE),
                      Min    = min(wells, na.rm = TRUE),
                      Max    = max(wells, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of Wells score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)
## Quick model
## .formula <- reformulate(response = 'pe',
##                         termlabels = c('wells'))
## dplyr::filter(dipep, group == 'Suspected PE') %>%
##     glm(formula = .formula,
##         family  = 'binomial')

```

```{r results_existing_simplified_revised_wells_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
summary.simplified <- dipep_existing_sum(df    = dipep,
                                         score = wells.pe)
kable(summary.simplified$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Wells Score.')
kable(summary.simplified$summary.table,
      digits = 3,
      caption = 'Performance indicators for the Wells Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

#### PERC Score

The PERC Score for study participants (@kline2004) is summarised below.  It should be noted that the PERC score is designed to be used when a diagnosis of PE is being considered but the risk is low (as described in the [online calculator](http://www.mdcalc.com/perc-rule-pulmonary-embolism/)).  A PERC Score $> 2$ (Moderate Risk) is taken as indicative of PE.

```{r results_existing_perc, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
ggplot(dplyr::filter(dipep, !is.na(pe)), aes(x = perc)) +
    geom_bar(aes(fill = pe), position = 'dodge') +
    ggtitle('PERC Scores by clinical classification') +
    xlab('PERC Score') + ylab('N') +
    scale_fill_discrete(guide = guide_legend(title = 'Status')) +
    theme_bw()
## Likert style plot of scores
plot.perc <- dplyr::select(existing, perc)
names(plot.perc) <- c('PERC Scores')
likert(plot.perc, grouping = existing$group) %>%
    plot(centered = 2) + labs(caption = 'Plots are centered on the Risk category.\n Percentages indicate the proportion below, within and above this.')
## Summary Tables
all <- dplyr::filter(dipep, !is.na(pe)) %>%
       summarise(N      = sum(!is.na(perc)),
                 Mean   = mean(perc, na.rm = TRUE),
                 SD     = sd(perc, na.rm = TRUE),
                 Lower  = quantile(perc, probs = 0.25, na.rm = TRUE),
                 Median = quantile(perc, probs = 0.5, na.rm = TRUE),
                 Upper  = quantile(perc, probs = 0.25, na.rm = TRUE),
                 Min    = min(perc, na.rm = TRUE),
                 Max    = max(perc, na.rm = TRUE)) %>%
       mutate(Status = 'All')
by.group <- dplyr::filter(dipep, !is.na(pe)) %>%
            group_by(pe) %>%
            summarise(N      = sum(!is.na(perc)),
                      Mean   = mean(perc, na.rm = TRUE),
                      SD     = sd(perc, na.rm = TRUE),
                      Lower  = quantile(perc, probs = 0.25, na.rm = TRUE),
                      Median = quantile(perc, probs = 0.5, na.rm = TRUE),
                      Upper  = quantile(perc, probs = 0.25, na.rm = TRUE),
                      Min    = min(perc, na.rm = TRUE),
                      Max    = max(perc, na.rm = TRUE)) %>%
            rename("Status" = pe)
rbind(all, by.group) %>%
dplyr::select(Status, N, Mean, SD, Lower, Median, Upper, Min, Max) %>%
kable(caption = 'Summary of PERC score individuals with Suspected PE',
      digits = 3)
rm(all, by.group)

```

```{r results_existing_simplified_revised_perc_accuracy, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
summary.simplified <- dipep_existing_sum(df    = dipep,
                                         score = perc.pe)
kable(summary.simplified$table,
      digits = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Perc Score.')
kable(summary.simplified$summary.table,
      digits = 3,
      caption = 'Performance indicators for the Perc Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```
