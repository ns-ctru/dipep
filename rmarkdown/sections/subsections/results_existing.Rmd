### Existing Scores {.tabset .tabset-fade .tabset-pills}

```{r results_existing_roc, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
to.plot <- dplyr::filter(dipep, !is.na(first.st) & group %in% c('Diagnosed PE', 'Suspected PE')) %>%
    ## ToDp 2017-02-23 - Add in Delphi scores
           dplyr::select(first.st, simplified.pe, wells.pe, perc.pe) %>%
           tidyr::gather(key = first.st)##  %>%
           ## mutate(value = ifelse(grepl('No', value),
           ##                       0,
           ##                       1))

names(to.plot) <- c('D', 'Score', 'value')
## Convert String variable to 0/1 for predicted probabilities
to.plot <- to.plot %>%
           dplyr::mutate(M     = ifelse(grepl('No', value), 0, 1),
                         Score = case_when(.$Score == 'simplified.pe' ~ 'Simplified Revised Geneva',
                                           .$Score == 'perc.pe'       ~ 'PERC',
                                           .$Score == 'wells.pe'      ~ 'Wells'))
ggplot(to.plot, aes(d = D, m = M, colour = Score)) +
    geom_roc() +
    guides(guide = guide_legend(title = 'Predictor Score...')) +
    ggtitle('ROC curves for Existing Pulmonary Embolism Predictors') +
    style_roc() + theme_bw()
## Extract the existing scores for Likert style plotting
existing <- dplyr::filter(dipep, !is.na(first.st) & group %in% c('Diagnosed PE', 'Suspected PE', 'Non recruited')) %>% dplyr::select(group, wells, simplified, perc)

```

**NB** - The results presented here do **NOT** include the `Non recruited` group.

#### Simplified Revised Geneva

The Simplified Revised Geneva score(@klok2008) is summarised below.  An [online calculator](https://www.mdcalc.com/geneva-score-revised-pulmonary-embolism) is available.  A score $> X$ is taken as indicative of PE.

```{r results_existing_simplified_revised_geneva, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Summarise
simplified <- dipep_existing_sum(df      = dipep,
                                 title   = 'Simplified Revised Geneva',
                                 exclude = NULL,
                                 first.st, simplified.pe, simplified)
## Plots
simplified$bar.chart
simplified$likert.plot
## Tables
kable(simplified$summary.table,
      caption = 'Summary of Simplified GENEVA score',
      digits = 3)
kable(simplified$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Simplified Revised Geneva Score.')
kable(simplified$performance.table,
      digits  = 3,
      caption = 'Performance indicators for the Simplified Revised Geneva Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```


#### Wells Score

The Wells Score (@wells2001) is summarised below.  An [online calculator](https://www.mdcalc.com/wells-criteria-pulmonary-embolism) is available.  A score $> X$ is taken as indicative of PE.

```{r results_existing_wells, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Summarise
wells <- dipep_existing_sum(df      = dipep,
                                 title   = 'Wells',
                                 exclude = NULL,
                                 first.st, wells.pe, wells)
## Plots
wells$bar.chart
wells$likert.plot
## Tables
kable(wells$summary.table,
      caption = 'Summary of Wells score',
      digits = 3)
kable(wells$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Wells Score.')
kable(wells$performance.table,
      digits  = 3,
      caption = 'Performance indicators for the Wells Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```


#### PERC Score

The PERC Score for study participants (@kline2004) is summarised below.  It should be noted that the PERC score is designed to be used when a diagnosis of PE is being considered but the risk is low (as described in the [online calculator](http://www.mdcalc.com/perc-rule-pulmonary-embolism/)).  A PERC Score $> 2$ (Moderate Risk) is taken as indicative of PE.

```{r results_existing_perc, echo = FALSE, cache = FALSE, results = 'markdown', eval = TRUE}
## Summarise
perc <- dipep_existing_sum(df      = dipep,
                                 title   = 'PERC',
                                 exclude = NULL,
                                 first.st, perc.pe, perc)
## Plots
perc$bar.chart
perc$likert.plot
## Tables
kable(perc$summary.table,
      caption = 'Summary of Perc score',
      digits = 3)
kable(perc$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on PERC Score.')
kable(perc$performance.table,
      digits  = 3,
      caption = 'Performance indicators for the PERC Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

#### Delphi Consensus  {.tabset .tabset-fade .tabset-pills}

The Delphi Consensus panel derived three scores, one overall score (`Primary`), one hoped to maximise sensitivity (`Sensitivity`), and one hoped to maximise specificity (`Specificity`).

##### Primary

```{r results_existing_delphi_primary, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
## Summarise
delphi.primary <- dipep_existing_sum(df      = dipep,
                                 title   = 'Delphi (Primary)',
                                 exclude = NULL,
                                 first.st, delphi.primary.pe, delphi.primary)
## Plots
delphi.primary$bar.chart
delphi.primary$likert.plot
## Tables
kable(delphi.primary$summary.table,
      caption = 'Summary of Delphi (Primary) score',
      digits = 3)
kable(delphi.primary$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Delphi (Primary) Score.')
kable(delphi.primary$performance.table,
      digits  = 3,
      caption = 'Performance indicators for the Delphi (Primary) Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

##### Sensitivity

```{r results_existing_delphi_sensitivity, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
delphi.sensitivity <- dipep_existing_sum(df      = dipep,
                                 title   = 'Delphi (Sensitivity)',
                                 exclude = NULL,
                                 first.st, delphi.sensitivity.pe, delphi.sensitivity)
## Plots
delphi.sensitivity$bar.chart
delphi.sensitivity$likert.plot
## Tables
kable(delphi.sensitivity$summary.table,
      caption = 'Summary of Delphi (Sensitivity) score',
      digits = 3)
kable(delphi.sensitivity$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Delphi (Sensitivity) Score.')
kable(delphi.sensitivity$performance.table,
      digits  = 3,
      caption = 'Performance indicators for the Delphi (Sensitivity) Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```

##### Specificity

```{r results_existing_delphi_specificity, echo = FALSE, cache = FALSE, results = 'markdown', eval = FALSE}
delphi.specificity <- dipep_existing_sum(df      = dipep,
                                 title   = 'Delphi (Specificity)',
                                 exclude = NULL,
                                 first.st, delphi.specificity.pe, delphi.specificity)
## Plots
delphi.specificity$bar.chart
delphi.specificity$likert.plot
## Tables
kable(delphi.specificity$summary.table,
      caption = 'Summary of Delphi (Specificity) score',
      digits = 3)
kable(delphi.specificity$table,
      digits  = 3,
      caption = 'Pulmonary Embolism status compared to predicted status based on Delphi (Specificity) Score.')
kable(delphi.specificity$performance.table,
      digits  = 3,
      caption = 'Performance indicators for the Delphi (Specificity) Score for Pulmonary Embolism applied retrospectively to the DiPEP data.')

```
