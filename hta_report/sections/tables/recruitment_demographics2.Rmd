```{r table_recruitment_demographics2, echo = FALSE, warning = FALSE, messages = FALSE, eval = TRUE}
to.table <- dplyr::filter(dipep,
                          group %in% c('Suspected PE', 'Non recruited')) %>%
            dplyr::select(screening, group, first.st, bmi, heart.rate, respiratory.rate, o2.saturation, bp.systolic, bp.diastolic, temperature, thromboprophylaxis, multiple.preg, thrombosis)%>%
            gather(key = response, value = value, first.st:thrombosis)
## Again, this is not a 'natural' table generated by cross-tabulating two variables it is a mixture
## of this and summary statistics, this necessitates building the table as components which
## then need combining.
##
## BMI, Heart Rate, Respiratory Rate, o2 Saturation, bp.systolic, bp.diastolic, temperature
table_recruitment_demographics2.physiology <- to.table %>%
                                              dplyr::filter(response %in% c('bmi',
                                                                            'heart.rate',
                                                                            'respiratory.rate',
                                                                            'o2.saturation',
                                                                            'bp.systolic',
                                                                            'bp.diastolic',
                                                                            'temperature')) %>%
                                              group_by(group, response) %>%
                                              summarise(n = sum(!is.na(value)),
                                                        mean = mean(as.numeric(value), na.rm = TRUE),
                                                        sd   = sd(as.numeric(value), na.rm = TRUE)) %>%
                                              ungroup() %>%
                                              mutate(mean_sd = paste0(formatC(mean, format = 'f', digits = digits),
                                                                      ' (',
                                                                      formatC(sd, format = 'f', digits = digits),
                                                                      ')'),
                                                     percent = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                         .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                         .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                         .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                                     n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                        ' (',
                                                                        formatC(percent, format = 'f', digits = digits.percent),
                                                                        '%)')) %>%
                                              dplyr::select(-mean, -sd, -percent, -n) %>%
                                              gather(key = statistic, value = value, mean_sd:n_percent) %>%
                                              spread(key = group, value = value) %>%
                                              mutate(statistic = case_when(.$statistic == 'mean_sd'   ~ 'Mean (SD)',
                                                                           .$statistic == 'n_percent' ~ 'N (%)'),
                                              response  = case_when(.$response == 'bmi' ~ 'BMI (kg/m^2)',
                                                                    .$response == 'bp.diastolic' ~ 'Systolic Blood Pressure (mmHg)',
                                                                    .$response == 'bp.systolic' ~ 'Diastolic Blood Pressure (mmHg)',
                                                                    .$response == 'respiratory.rate' ~ 'Respiratory Rate (breaths/minute)',
                                                                    .$response == 'o2.saturation' ~ 'Oxygen Saturation (%)',
                                                                    .$response == 'heart.rate' ~ 'Heart Rate (bpm)',
                                                                    .$response == 'temperature' ~ 'Temperature (C)'))
## Now the other four components required
table_recruitment_demographics2.other <- to.table %>%
                                         dplyr::filter(response %in% c('first.st',
                                                                       'thromboprophylaxis',
                                                                       'multiple.preg',
                                                                       'thrombosis')) %>%
                                         group_by(group, response, value) %>%
                                         summarise(n = n()) %>%
                                         ungroup() %>%
                                         mutate(value = ifelse(is.na(value),
                                                               yes = 'Missing',
                                                               no  = value),
                                                percent = case_when(.$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                    .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe,
                                                                    .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                    .$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt),
                                                n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                   ' (',
                                                                   formatC(percent, format = 'f', digits = digits.percent),
                                                                   '%)'),
                                                component = case_when(.$response == 'first.st' ~ 'Primary Classification',
                                                                      .$response == 'thromboprophylaxis' ~ 'Thromboprophylaxis',
                                                                      .$response == 'multiple.preg' ~ 'Multiple Pregnancy',
                                                                      .$response == 'thrombosis' ~ 'Primary Classification'),
                                                answer    = value) %>%
                                         dplyr::select(-n, -percent, -response, -value) %>%
                                         gather(key = statistic, value = value, n_percent) %>%
                                         spread(key = group, value = value) %>%
                                         dplyr::select(-statistic) %>%
                                         mutate(`Non recruited` = ifelse(is.na(`Non recruited`),
                                                                         yes = '0 (0%)',
                                                                         no  = `Non recruited`),
                                                `Suspected PE` = ifelse(is.na(`Suspected PE`),
                                                                        yes = '0 (0%)',
                                                                        no  = `Suspected PE`))
                                                ## `Diagnosed PE` = ifelse(is.na(`Diagnosed PE`),
                                                ##                                yes = '0 (0%)',
                                                ##                          no  = `Diagnosed PE`),
                                                ## `Diagnosed DVT` = ifelse(is.na(`Diagnosed DVT`),
                                                ##                                yes = '0 (0%)',
                                                ##                          no  = `Diagnosed DVT`)
names(table_recruitment_demographics2.other) <- c('response', 'statistic', 'Non recruited', 'Suspected PE')
## Bind into one table and sort formatting
table_recruitment_demographics2 <- rbind(table_recruitment_demographics2.physiology,
                                         table_recruitment_demographics2.other) %>%
                                   group_by(response) %>%
                                   mutate(id       = 1:n(),
                                          Variable = ifelse(id == 1,
                                                            yes = response,
                                                            no  = '')) %>%
                                   ungroup() %>%
                                   dplyr::select(Variable,
                                                 statistic,
                                                 ## `Diagnosed DVT`,
                                                 `Non recruited`,
                                                 ## `Diagnosed PE`,
                                                 `Suspected PE`)
kable(table_recruitment_demographics2,
      caption = 'Demographics by recruitment Group',
      col.names = c('Variable', 'Statistic',
                    ## head.diagnosed.dvt,
                    head.non.recruited,
                    ## head.diagnosed.pe,
                    head.suspected.pe))


```
