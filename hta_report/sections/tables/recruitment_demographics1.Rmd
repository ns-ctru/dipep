```{r table_recruitment_demographics1, echo = FALSE, warning = FALSE, messages = FALSE, eval = TRUE}
to.table <- dplyr::select(dipep,
                          screening,
                          group,
                          age,
                          ethnicity,
                          marital.status,
                          employment,
                          pregnancies.over,
                          pregnancies.under,
                          trimester) %>%
    mutate(previous.pregnancies = pregnancies.under + pregnancies.over) %>%
    gather(key = response, value = value, age:previous.pregnancies)
## This is not a 'natural' table generated by cross-tabulating two variables it is a mixture
## of this and summary statistics, this necessitates building the table as components which
## then need combining.
##
## N and Age
table_recruitment_demographics1.age <- to.table %>%
                                       dplyr::filter(response == 'age') %>%
                                       group_by(group) %>%
                                       summarise(n = sum(!is.na(value)),
                                                 mean = mean(as.numeric(value), na.rm = TRUE),
                                                 sd   = sd(as.numeric(value), na.rm = TRUE)) %>%
                                       ungroup() %>%
                                       mutate(mean_sd = paste0(formatC(mean, format = 'f', digits = digits),
                                                               ' (',
                                                               formatC(sd, format = 'f', digits = digits),
                                                               ')'),
                                              percent = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                  .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                  .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                  .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                              n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                 ' (',
                                                                 formatC(percent, format = 'f', digits = digits.percent),
                                                                 '%)')) %>%
                                       dplyr::select(-mean, -sd, -percent, -n) %>%
                                       gather(key = statistic, value = value, mean_sd:n_percent) %>%
                                       spread(key = group, value = value) %>%
                                       mutate(statistic = case_when(.$statistic == 'mean_sd'   ~ 'Mean (SD)',
                                                                    .$statistic == 'n_percent' ~ 'N (%)'),
                                              component = 'Age')
## Ethnicity
table_recruitment_demographics1.ethnicity <- to.table %>%
                                             dplyr::filter(response == 'ethnicity') %>%
                                             group_by(group, value) %>%
                                             summarise(n = n()) %>%
                                             ungroup() %>%
                                             mutate(percent   = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                          .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                          .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                          .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                                    n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                       ' (',
                                                                       formatC(percent, format = 'f', digits = digits.percent),
                                                                       '%)')) %>%
                                             dplyr::select(-n, -percent) %>%
                                             spread(key = group, value = n_percent) %>%
                                             mutate(component = 'Ethnicity',
                                                    value     = ifelse(is.na(value),
                                                                       yes = 'Missing',
                                                                       no  = value))
names(table_recruitment_demographics1.ethnicity) <- gsub('value', 'statistic', names(table_recruitment_demographics1.ethnicity))
## Marital Status
table_recruitment_demographics1.marital <- to.table %>%
                                           dplyr::filter(response == 'marital.status') %>%
                                           group_by(group, value) %>%
                                           summarise(n = n()) %>%
                                           ungroup() %>%
                                           mutate(percent   = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                        .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                        .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                        .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                                  n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                     ' (',
                                                                     formatC(percent, format = 'f', digits = digits.percent),
                                                                     '%)')) %>%
                                           dplyr::select(-n, -percent) %>%
                                           spread(key = group, value = n_percent) %>%
                                           mutate(component = 'Marital Status',
                                                  value     = case_when(is.na(.$value)          ~ 'Missing',
                                                                        .$value == 'cohabiting' ~ 'Cohabiting',
                                                                        .$value == 'married' ~ 'Married',
                                                                        .$value == 'single' ~ 'Single'))
names(table_recruitment_demographics1.marital) <- gsub('value', 'statistic', names(table_recruitment_demographics1.marital))
## Employment Status
table_recruitment_demographics1.employment <- to.table %>%
                                              dplyr::filter(response == 'employment') %>%
                                              group_by(group, value) %>%
                                              summarise(n = n()) %>%
                                              ungroup() %>%
                                              mutate(percent   = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                           .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                           .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                           .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                                     n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                     ' (',
                                                                     formatC(percent, format = 'f', digits = digits),
                                                                     '%)')) %>%
                                              dplyr::select(-n, -percent) %>%
                                              spread(key = group, value = n_percent) %>%
                                              mutate(component = 'Employment Status',
                                                     value     = case_when(is.na(.$value)   ~ 'Missing',
                                                                           .$value == 'Yes' ~ 'Employed',
                                                                           .$value == 'No'  ~ 'Unemployed'))
names(table_recruitment_demographics1.employment) <- gsub('value', 'statistic', names(table_recruitment_demographics1.employment))
## Previous Pregnancies
table_recruitment_demographics1.previous <- to.table %>%
                                            dplyr::filter(response %in% c('pregnancies.under', 'pregnancies.over')) %>%
                                            group_by(group, response, value) %>%
                                            summarise(n = n()) %>%
                                            ungroup() %>%
                                            mutate(percent   = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                         .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                         .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                         .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                                   n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                      ' (',
                                                                      formatC(percent, format = 'f', digits = digits.percent),
                                                                      '%)')) %>%
                                            dplyr::select(-n, -percent) %>%
                                            spread(key = group, value = n_percent) %>%
                                            mutate(response = case_when(.$response == 'pregnancies.over' ~ 'Pregnancies > 24 weeks',
                                                                        .$response == 'pregnancies.under' ~ 'Pregnancies < 24 weeks'),
                                                   value     = case_when(is.na(.$value)   ~ 'Missing',
                                                                         !is.na(.$value)  ~ .$value))
names(table_recruitment_demographics1.previous) <- gsub('value', 'statistic', names(table_recruitment_demographics1.previous))
names(table_recruitment_demographics1.previous) <- gsub('response', 'component', names(table_recruitment_demographics1.previous))
## Trimester
table_recruitment_demographics1.trimester <- to.table %>%
                                             dplyr::filter(response == 'trimester') %>%
                                             group_by(group, value) %>%
                                             summarise(n = n()) %>%
                                             ungroup() %>%
                                             mutate(percent   = case_when(.$group == 'Diagnosed DVT' ~ (100 * .$n) / n.diagnosed.dvt,
                                                                          .$group == 'Diagnosed PE' ~ (100 * .$n) / n.diagnosed.pe,
                                                                          .$group == 'Non recruited' ~ (100 * .$n) / n.non.recruited,
                                                                          .$group == 'Suspected PE' ~ (100 * .$n) / n.suspected.pe),
                                                     n_percent = paste0(formatC(n, format = 'f', digits = 0),
                                                                        ' (',
                                                                        formatC(percent, format = 'f', digits = digits),
                                                                        '%)')) %>%
                                             dplyr::select(-n, -percent) %>%
                                             spread(key = group, value = n_percent) %>%
                                             mutate(component = 'Gestational Age',
                                                   value     = case_when(is.na(.$value)   ~ 'Missing',
                                                                         !is.na(.$value)  ~ .$value))
names(table_recruitment_demographics1.trimester) <- gsub('value', 'statistic', names(table_recruitment_demographics1.trimester))
## Bind into one table
table_recruitment_demographics1 <- rbind(table_recruitment_demographics1.age,
                                         table_recruitment_demographics1.ethnicity,
                                         table_recruitment_demographics1.marital,
                                         table_recruitment_demographics1.employment,
                                         table_recruitment_demographics1.previous,
                                         table_recruitment_demographics1.trimester) %>%
                                   group_by(component) %>%
                                   mutate(id       = 1:n(),
                                          Variable = ifelse(id == 1,
                                                            yes = component,
                                                            no  = '')) %>%
                                   ungroup() %>%
                                   dplyr::select(Variable,
                                                 statistic,
                                                 `Diagnosed DVT`,
                                                 `Non recruited`,
                                                 `Diagnosed PE`,
                                                 `Suspected PE`)
kable(table_recruitment_demographics1,
      caption   = 'Demographics by recruitment Group',
      col.names = c('Variable', 'Statistic',
                    head.diagnosed.dvt,
                    head.non.recruited,
                    head.diagnosed.pe,
                    head.suspected.pe))

```
