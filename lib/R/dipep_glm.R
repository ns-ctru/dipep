#' Wrapper for running univariable logistic regression
#'
#' @description Wrapper for running univariable logistic regression
#'
#' @details
#'
#' This wrapper runs logistic regression models for a given predictor variable
#' and returns the fitted model (for combining using broom()) along with the
#' predicted values (for calculation of sensitivity and specificity) as well
#' as other summary statistics
#'
#'
#' @param df Data frame to analyse (default is \code{dipep} and shouldn't need changing)
#' @param classification Specify the variable that defines the disease status, for this study there are four classifications of diseases ststus, hence the need for flexibility.
#' @param predictor Predictor variable(s) to test.
#' @param model Name/label of your model.
#' @param relevel Reference level for logistic regression if different from default.
#'
#'
#' @export
dipep_glm <- function(df              = .data,
                      classification  = 'first.st',
                      predictor       = 'age',
                      model           = NULL,
                      relevel         = NULL,
                      ...){
    results <- list()
    ## Build the formula
    .formula <- reformulate(response = classification,
                            termlabels = predictor)
    ## Relevel if asked
    ## ToDo - Check this, may not work correctly (usual NSE issues)
    if(!is.null(relevel)){
        df$predictor <- relevel(df$predictor,
                                ref = relevel)
    }
    ## Make the model equal the predictor if none is supplied
    if(is.null(model)){
        model <- predictor
    }
    ## Filter the data frame, need to remove all Non-recruited and
    ## those who can not be classified as PE/No PE
    results$df <- dplyr::filter(df, group != 'Non recruited') %>%
                  dplyr::filter_(!is.na(classification)) %>%
                  dplyr::select_(.dots = c(classification, predictor)) %>%
                  mutate(obs = rownames(.),
                         use = complete.cases(.)) %>%
                  dplyr::filter(use == TRUE) %>%
                  dplyr::select(-use)
    results$df$obs <- rownames(results$df)
    ## Test the model
    results$fitted <- glm(.formula,
                          data   = results$df,
                          family = 'binomial')
    ## Use Broom to sweep up/tidy the results
    results$tidied    <- broom::tidy(results$fitted)
    results$tidied <- mutate(results$tidied,
                             term = gsub('age.catYoung', 'Age (Young)', term),
                             term = gsub('age.catOld', 'Age (Old)', term),
                             term = gsub('age', 'Age (Continuous)', term),
                             term = gsub('smokinggave up prior to pregnancy', 'Ex-smoker (Prior)', term),
                             term = gsub('smokinggave up during pregnancy', 'Ex-smoker (During)', term),
                             term = gsub('smokingcurrent', 'Current Smoker', term),
                             term = gsub('temperature.catLow', 'Temperature (Low)', term),
                             term = gsub('temperature.catHigh', 'Temperature (High)', term),
                             term = gsub('temperature', 'Temperature (Continuous)', term),
                             term = gsub('bp.diastolic.catLow', 'Diastolic (Low)', term),
                             term = gsub('bp.diastolic.catHigh', 'Diastolic (High)', term),
                             term = gsub('bp.diastolic', 'Diastolic (Continuous)', term),
                             term = gsub('bp.systolic.catLow', 'Systolic (Low)', term),
                             term = gsub('bp.systolic.catHigh', 'Systolic (High)', term),
                             term = gsub('bp.systolic', 'Systolic (Continuous)', term),
                             term = gsub('o2.saturation.catLow', 'O2 Saturation (Low)', term),
                             term = gsub('o2.saturation.catHigh', 'O2 Saturation (High)', term),
                             term = gsub('o2.saturation', 'O2 Saturation (Continuous)', term),
                             term = gsub('respiratory.rate.catLow', 'Respiratory Rate (Low)', term),
                             term = gsub('respiratory.rate.catHigh', 'Respiratory Rate (High)', term),
                             term = gsub('respiratory.rate', 'Respiratory Rate (Continuous)', term),
                             term = gsub('heart.rate.catLow', 'Heart Rate (Low)', term),
                             term = gsub('heart.rate.catHigh', 'Heart Rate (High)', term),
                             term = gsub('heart.rate', 'Heart Rate (Continuous)', term),
                             term = gsub('bmi.catLow', 'BMI (Low)', term),
                             term = gsub('bmi.catHigh', 'BMI (High)', term),
                             term = gsub('bmi', 'BMI (Continuous)', term),
                             term = gsub('Ticked', '', term),
                             term = gsub('presenting.features.pleuritic', 'Presenting : Pleuritic', term),
                             term = gsub('presenting.features.non.pleuritic', 'Presenting : Non-Pleuritic', term),
                             term = gsub('presenting.features.sob.exertion', 'Presenting : Shortness of Breath (Exertion)', term),
                             term = gsub('presenting.features.sob.rest', 'Presenting : Shortness of Breath (Rest)', term),
                             term = gsub('presenting.features.haemoptysis', 'Presenting : Haemoptysis', term),
                             term = gsub('presenting.features.cough', 'Presenting : Cough', term),
                             term = gsub('presenting.features.syncope', 'Presenting : Syncope', term),
                             term = gsub('presenting.features.palpitations', 'Presenting : Palpitations', term),
                             term = gsub('presenting.features.other', 'Presenting : Other', term),
                             term = gsub('pregnancies.under.cat', '>= 1 Pregnancy < 24 weeks', term),
                             term = gsub('pregnancies.over.cat', '>= 1 Pregnancy > 24 weeks', term),
                             term = gsub('pregnancies.under', 'Pregnancies < 24 weeks (Continuous)', term),
                             term = gsub('pregnancies.over', 'Pregnancies > 24 weeks (Continuous)', term),
                             term = gsub('prev.preg.problemNo', 'No Previous Pregnancy Problems', term),
                             term = gsub('prev.preg.problemYes', 'Previous Pregnancy Problems', term),
                             term = gsub('history.thrombosisNo', 'No Family History of Thrombosis', term),
                             term = gsub('history.thrombosisYes', 'Family History of Thrombosis', term),
                             term = gsub('history.veinsNo', 'No History of Varicose Veins', term),
                             term = gsub('history.veinsYes', 'History of Varicose Veins', term),
                             term = gsub('history.iv.drugNo', 'No History of IV Drug use', term),
                             term = gsub('history.iv.drugYes', 'History of IV Drug use', term),
                             term = gsub('thrombosisNo', 'NoHistory of Thrombosis', term),
                             term = gsub('thrombosisYes', 'History of Thrombosis', term),
                             term = gsub('trimester1st Trimester', '1st Trimester', term),
                             term = gsub('trimester2nd Trimester', '2nd Trimester', term),
                             term = gsub('trimester3rd Trimester', '3rd Trimester', term),
                             term = gsub('trimesterPost-Partum', 'Post-Partum', term),
                             term = gsub('this.pregnancy.problemsYes', 'Problems with this Pregnancy', term),
                             term = gsub('surgeryYes', 'Surgery in previous 4 weeks', term),
                             term = gsub('surgeryYes', 'No Surgery in previous 4 weeks', term),
                             term = gsub('thromboYes', 'Known Thrombophilia', term),
                             term = gsub('multiple.pregYes', 'Multiple Pregnancy', term),
                             term = gsub('travelYes', 'Long-haul travel during pregnancy', term),
                             term = gsub('immobilYes', '>=3 days Immobility/bed rest during pregnancy', term),
                             term = gsub('ecgNormal', 'ECG : Normal', term),
                             term = gsub('ecgAbnormal', 'ECG : Abnormal', term),
                             term = gsub('ecgNot performed', 'ECG : Not Performed', term),
                             term = gsub('ecg.catAbnomral ECG', 'ECG (Binary) : Abnormal', term),
                             term = gsub('xrayNormal', 'X-ray : Normal', term),
                             term = gsub('xrayAbnormal', 'X-ray : Abnormal', term),
                             term = gsub('xrayNot performed', 'X-ray : Not Performed', term),
                             term = gsub('xray.catAbnormal X-Ray', 'X-ray (Binary) : Abnormal', term))
    ## Get the predicted response out
    results$augmented <- broom::augment(results$fitted, type.predict = 'response')
    results$glance    <- broom::glance(results$fitted)
    ## Add the predictor to each to make it easier combining
    results$tidied$model    <- model
    results$augmented$model <- model
    results$glance$model    <- model
    ## Get predicted probabilities
    ## results$predicted <- results$fitted %>% predict() %>% as.data.frame()
    ## names(results$predicted) <- c('pred')
    ## results$predicted$obs <- rownames(results$predicted)
    ## results$predicted <- merge(dplyr::select(results$df, obs, pe),
    ##                            results$predicted,
    ##                            by = c('obs'))
    ## results$predicted <- cbind(predict(results$fitted, type = 'response'),
    ##                            results$fitted$y) %>%
    ##                      as.data.frame()
    ## names(results$predicted) <- c('predicted', 'pe')
    ## Extract these from the 'augmented' data frame
    results$predicted <- dplyr::select_(results$augmented, classification, '.fitted')
    if(length(predictor) == 1){
        results$predicted$name <- predictor
    }
    else{
        results$predicted$name <- model
    }
    results$predicted$term <- model
    names(results$predicted) <- gsub('.fitted', 'M', names(results$predicted))
    names(results$predicted) <- gsub(classification, 'D', names(results$predicted))
    ## Return ROC curve for this model
    results$roc <- ggplot(results$predicted,
                          aes(d = D, m = M)) +
                   geom_roc() +
                   guides(guide = guide_legend(title = '')) +
                   ggtitle(paste0('ROC curve for ', model)) +
                   style_roc() + theme_bw()
    ## Add the AUC
    results$auc <- calc_auc(results$roc)
    results$roc <- results$roc +
                   annotate('text', x = 0.75, y = 0.25,
                            label = paste0('AUC = ', round(results$auc$AUC, 3)))
    return(results)
}
