#' Wrapper for running univariable logistic regression
#'
#' @description Wrapper for running univariable logistic regression
#'
#' @details
#'
#' This wrapper runs logistic regression models for a given predictor variable
#' and returns the fitted model (for combining using broom()) along with the
#' predicted values (for calculation of sensitivity and specificity) as well
#' as other summary statistics
#'
#'
#' @param df Data frame to analyse (default is \code{dipep} and shouldn't need changing)
#' @param classification Specify the variable that defines the disease status, for this study there are four classifications of diseases ststus, hence the need for flexibility.
#' @param predictor Predictor variable(s) to test.
#' @param model Name/label of your model.
#' @param relevel Reference level for logistic regression if different from default.
#' @param exclude Vector of \code{screening}  to exclude.
#' @param exclude.non.recuirted Logical indicator of whether to exclude \code{group == 'Non recruited'}.
#' @param exclude.dvt Logical indicator of whether to exclude \code{group == 'Diagnosed DVT'}.
#' @param exclude.anti.coag Logical indicator of whether to exclude individuals who had received anti-coagulents prior to blood samples being taken (default is \code{FALSE} and it is only relevant to set to \code{TRUE} when analysing certain biomarkers).
#' @param exclude.missing Exclude individuals flagged as having excessive missing data.
#'
#' @export
dipep_glm <- function(df              = .data,
                      classification  = 'first.st',
                      predictor       = 'age',
                      model           = NULL,
                      relevel         = NULL,
                      exclude         = NULL,
                      exclude.non.recruited = TRUE,
                      exclude.dvt       = TRUE,
                      exclude.anti.coag = FALSE,
                      exclude.missing   = FALSE,
                      ...){
    results <- list()
    ## Remove individuals who are explicitly to be removed
    if(!is.null(exclude)){
        df <- df[!(df$screening %in% exclude),]
        ## df <- dplyr::filter_(df, ('screening' %in% !exclude))
    }
    ## Remove non-recruited, DVT or missing
    if(exclude.non.recruited == TRUE){
        df <- dplyr::filter(df, group != 'Non recruited')
    }
    if(exclude.dvt == TRUE){
        df <- dplyr::filter(df, group != 'Diagnosed DVT')
    }
    ## If DVT are NOT being excluded then this will be biomarker data that is
    ## being analysed and we therefore need to INCLUDE DVT WITH PE
    else{
        df <- df %>%
              mutate(first.st  = as.character(first.st),
                     second.st = as.character(second.st),
                     third.st  = as.character(third.st),
                     fourth.st = as.character(fourth.st)) %>%
              mutate(first.st = case_when(substr(.$screening, 1, 1) == 'D'  ~ 'PE',
                                          substr(.$screening, 1, 1) != 'D'  ~ .$first.st),
                     second.st = case_when(substr(.$screening, 1, 1) == 'D' ~ 'PE',
                                           substr(.$screening, 1, 1) != 'D' ~ .$second.st),
                     third.st = case_when(substr(.$screening, 1, 1) == 'D'  ~ 'PE',
                                          substr(.$screening, 1, 1) != 'D'  ~ .$third.st),
                     fourth.st = case_when(substr(.$screening, 1, 1) == 'D' ~ 'PE',
                                           substr(.$screening, 1, 1) != 'D' ~ .$fourth.st)) %>%
              mutate(first.st = factor(first.st,
                                       levels = c('No PE', 'PE')),
                     second.st = factor(second.st,
                                        levels = c('No PE', 'PE')),
                     third.st = factor(third.st,
                                       levels = c('No PE', 'PE')),
                     fourth.st = factor(fourth.st,
                                        levels = c('No PE', 'PE')))
    }
    if(exclude.missing == TRUE){
        df <- dplyr::filter(df, missing.exclude == FALSE)
    }
    ## Exclude those who are not classified as PE/No PE by
    ## the specified classification
    ## TODO 2017-02-17 : Why doesn dplyr::filter_(df, !is.na(classification)) not work???
    if(classification == 'first.st'){
        df <- dplyr::filter(df, !is.na(first.st))
    }
    else if(classification == 'second.st'){
        df <- dplyr::filter(df, !is.na(second.st))
    }
    else if(classification == 'third.st'){
        df <- dplyr::filter(df, !is.na(third.st))
    }
    else if(classification == 'fourth.st'){
        df <- dplyr::filter(df, !is.na(fourth.st))
    }
    else if(classification == 'primary.dm'){
        df <- dplyr::filter(df, !is.na(primary.dm))
    }
    else if(classification == 'secondary.dm'){
        df <- dplyr::filter(df, !is.na(secondary.dm))
    }
    else if(classification == 'vte'){
        df <- dplyr::filter(df, !is.na(vte))
    }
    ## Remove biomarker data for those on anticoagulents
    if(exclude.anti.coag == TRUE){
        df <- mutate(df,
                     prothombin.time                          = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = prothombin.time),
                     aptt                                     = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = aptt),
                     clauss.fibrinogen                        = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = clauss.fibrinogen),
                     ddimer.innovance                         = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = ddimer.innovance),
                     ddimer.elisa                             = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = ddimer.elisa),
                     d.dimer.cat                              = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = d.dimer.cat),
                     d.dimer.gestation.cat                    = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = d.dimer.gestation.cat),
                     d.dimer                                  = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = d.dimer),
                     thrombin.generation.lag.time             = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = thrombin.generation.lag.time),
                     thrombin.generation.endogenous.potential = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = thrombin.generation.endogenous.potential),
                     thrombin.generation.peak                 = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = thrombin.generation.peak),
                     thrombin.generation.time.to.peak         = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = thrombin.generation.time.to.peak),
                     plasmin.antiplasmin                      = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = plasmin.antiplasmin),
                     prothrombin.fragments                    = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = prothrombin.fragments),
                     tissue.factor                            = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = tissue.factor),
                     troponin                                 = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = troponin),
                     bnp                                     = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = bnp),
                     mrproanp                                 = ifelse(exclude.anti.coag == 'Yes',
                                                                       yes = NA,
                                                                       no  = mrproanp))
    }
    ## Build the formula
    .formula <- reformulate(response = classification,
                            termlabels = predictor)
    ## Relevel if asked
    ## ToDo - Check this, may not work correctly (usual NSE issues)
    if(!is.null(relevel)){
        df$predictor <- relevel(df$predictor,
                                ref = relevel)
    }
    ## Make the model equal the predictor if none is supplied
    if(is.null(model)){
        model <- predictor
    }
    ## Cross tabulation of counts for combining
    results$table <- dplyr::group_by_(df, classification, predictor) %>%
                     dplyr::summarise(n = n()) %>%
                     dplyr::group_by_(classification) %>%
                     ## dplyr::group_by_(predictor) %>%
                     dplyr::mutate(N    = sum(n, na.rm = TRUE),
                                   prop = (n * 100) / N,
                                   n    = paste0(formatC(n, digits = 0, format = 'f'),
                                                 ' (',
                                                 formatC(prop, digits = 2, format = 'f'),
                                                 '%)'))
    names(results$table) <- c('classification', 'levels', 'n', 'N', 'prop')
    results$table <- results$table[c(1:3)]
    results$table <- dcast(results$table, levels ~ classification) %>%
                     mutate(predictor = predictor,
                            predictor = gsub('simplified.age', 'Geneva : Age', predictor),
                            predictor = gsub('simplified.prev.dvt.pe', 'Geneva : Previous DVT/PE', predictor),
                            predictor = gsub('simplified.surgery', 'Geneva : Surgery', predictor),
                            predictor = gsub('simplified.neoplasm', 'Geneva : Neoplasm', predictor),
                            predictor = gsub('simplified.lower.limb.unilateral.pain', 'Geneva : Unilateral Lower Limb Pain', predictor),
                            predictor = gsub('simplified.haemoptysis', 'Geneva : Haemoptysis', predictor),
                            predictor = gsub('simplified.heart.rate', 'Geneva : Heart Rate', predictor),
                            predictor = gsub('simplified.pain.palpitations', 'Geneva : Pain on limb palpitation', predictor),
                            predictor = gsub('perc.age', 'PERC : Age', predictor),
                            predictor = gsub('perc.heart.rate', 'PERC : Heart Rate', predictor),
                            predictor = gsub('perc.o2.saturation', 'PERC : O2 Saturation', predictor),
                            predictor = gsub('perc.prev.dvt.pe', 'PERC : Previous DVT/PE', predictor),
                            predictor = gsub('perc.surgery', 'PERC : Recent Trauma or Surgery', predictor),
                            predictor = gsub('perc.haemoptysis', 'PERC : Haemoptysis', predictor),
                            predictor = gsub('perc.hormone', 'PERC : Exogenous Estrogen', predictor),
                            predictor = gsub('perc.leg.swelling', 'PERC : Unilateral Leg Swelling', predictor),
                            predictor = gsub('wells.dvt', 'Wells : DVT', predictor),
                            predictor = gsub('wells.alternative.permissive', 'Wells : PE most likely (Permissive)', predictor),
                            predictor = gsub('wells.alternative.strict', 'Wells : PE most likely (Strict)', predictor),
                            predictor = gsub('wells.heart.rate', 'Wells : Heart Rate', predictor),
                            predictor = gsub('wells.surgery.immobil', 'Wells : Surgery/Immobility', predictor),
                            predictor = gsub('wells.dvt.pe', 'Wells : Previous DVT/PE', predictor),
                            predictor = gsub('wells.haemoptysis', 'Wells : Haemoptysis', predictor),
                            predictor = gsub('wells.neoplasm', 'Wells : Neoplasm', predictor),
                            predictor = gsub('delphi.haemoptysis', 'Delphi : Haemoptysis', predictor),
                            predictor = gsub('delphi.pleuritic', 'Delphi : Pleuritic', predictor),
                            predictor = gsub('delphi.history.dvt.pe', 'Delphi : History DVT/PE', predictor),
                            predictor = gsub('delphi.family.history', 'Delphi : Family History', predictor),
                            predictor = gsub('delphi.medical.history', 'Delphi : Medical History', predictor),
                            predictor = gsub('delphi.obstetric.complication', 'Delphi : Obstetric Complication', predictor),
                            predictor = gsub('delphi.medical.complication', 'Delphi : Medical Complication', predictor),
                            predictor = gsub('delphi.gestation', 'Delphi : Gestation', predictor),
                            predictor = gsub('delphi.bmi', 'Delphi : BMI', predictor),
                            predictor = gsub('delphi.dvt', 'Delphi : DVT', predictor),
                            predictor = gsub('delphi.o2.saturation', 'Delphi : O2 Saturation', predictor),
                            predictor = gsub('delphi.heart.rate', 'Delphi : Heart Rate', predictor),
                            predictor = gsub('delphi.respiratory.rate', 'Delphi : Respiratory Rate', predictor),
                            predictor = gsub('age.cat', 'Age (Categorised)', predictor),
                            predictor = gsub('smoking', 'Smoking Status', predictor),
                            predictor = gsub('temperature.cat', 'Temperature (Categorised)', predictor),
                            predictor = gsub('bp.diastolic.cat', 'Diastolic (Categorised)', predictor),
                            predictor = gsub('bp.systolic.cat', 'Systolic (Categorised)', predictor),
                            predictor = gsub('o2.saturation.cat', 'O2 Saturation (Categorised)', predictor),
                            predictor = gsub('respiratory.rate.cat', 'Respiratory Rate (Categorised)', predictor),
                            predictor = gsub('heart.rate.cat', 'Heart Rate (Categorised)', predictor),
                            predictor = gsub('bmi.cat', 'BMI (Categorised)', predictor),
                            predictor = gsub('presenting.features.pleuritic', 'Presenting : Pleuritic', predictor),
                            predictor = gsub('presenting.features.non.pleuritic', 'Presenting : Non-Pleuritic', predictor),
                            predictor = gsub('presenting.features.sob.exertion', 'Presenting : Shortness of Breath (Exertion)', predictor),
                            predictor = gsub('presenting.features.sob.rest', 'Presenting : Shortness of Breath (Rest)', predictor),
                            predictor = gsub('presenting.features.haemoptysis', 'Presenting : Haemoptysis', predictor),
                            predictor = gsub('presenting.features.cough', 'Presenting : Cough', predictor),
                            predictor = gsub('presenting.features.syncope', 'Presenting : Syncope', predictor),
                            predictor = gsub('presenting.features.palpitations', 'Presenting : Palpitations', predictor),
                            predictor = gsub('presenting.features.other', 'Presenting : Other', predictor),
                            predictor = gsub('pregnancies.under.cat', '>= 1 Pregnancy < 24 weeks', predictor),
                            predictor = gsub('pregnancies.over.cat', '>= 1 Pregnancy > 24 weeks', predictor),
                            predictor = gsub('prev.preg.problem', 'Previous Pregnancy Problems', predictor),
                            predictor = gsub('history.thrombosis', 'Family History of Thrombosis', predictor),
                            predictor = gsub('history.veins', 'History of Varicose Veins', predictor),
                            predictor = gsub('history.iv.drug', 'History of IV Drug use', predictor),
                            predictor = gsub('thrombosis', 'History of Thrombosis', predictor),
                            predictor = gsub('trimester', 'Trimester', predictor),
                            predictor = gsub('this.pregnancy.problems', 'Problems with this Pregnancy', predictor),
                            predictor = gsub('surgery', 'Surgery in previous 4 weeks', predictor),
                            predictor = gsub('thrombo', 'Known Thrombophilia', predictor),
                            predictor = gsub('multiple.preg', 'Multiple Pregnancy', predictor),
                            predictor = gsub('travel', 'Long-haul travel during pregnancy', predictor),
                            predictor = gsub('immobil', '<3 days Immobility/bed rest during pregnancy', predictor),
                            predictor = gsub('dvt.cat', 'Clinical DVT', predictor),
                            predictor = gsub('thromb.event', 'Previous Thrombotic Event', predictor),
                            predictor = gsub('ecg', 'ECG', predictor),
                            predictor = gsub('ecg.pe', 'ECG (PE Related)', predictor),
                            predictor = gsub('xray', 'X-ray', predictor),
                            predictor = gsub('xray.pe', 'X-ray (PE Related)', predictor),
                            predictor = gsub('aptt', 'APTT', predictor),
                            predictor = gsub('aptt.cat', 'APTT : Dichotomised', predictor),
                            predictor = gsub('prothombin.time', 'Prothombin Time', predictor),
                            predictor = gsub('prothombin.time.cat', 'Prothombin Time : Dichotomised', predictor),
                            predictor = gsub('clauss.fibrinogen', 'Clauss Fibrinogen', predictor),
                            predictor = gsub('clauss.fibrinogen.cat', 'Clauss Fibrinogen : Dichotomised', predictor),
                            predictor = gsub('ddimer.innovan', 'D-Dimer (Innovan)', predictor),
                            predictor = gsub('ddimer.innovan.cat', 'D-Dimer (Innovan) : Dichotomised', predictor),
                            predictor = gsub('ddimer.elisa', 'D-Dimer (ELISA)', predictor),
                            predictor = gsub('ddimer.elisa.cat', 'D-Dimer (ELISA) : Dichotomised', predictor),
                            predictor = gsub('d.dimer.cat', 'D-Dimer (Hospital) : Dichotomised', predictor),
                            predictor = gsub('d.dimer.gestation.cat', 'D-Dimer (Hospital) : Dichotomised (Gestation Specific)', predictor),
                            predictor = gsub('d.dimer', 'D-Dimer (Hospital)', predictor),
                            predictor = gsub('thrombin.generation.lag.time', 'Thrombin Generation (Lag Time)', predictor),
                            predictor = gsub('thrombin.generation.lag.time.cat', 'Thrombin Generation (Lag Time) : Dichotomised', predictor),
                            predictor = gsub('thrombin.generation.endogenous.potential', 'Thrombin Generation (Endogenous Potential)', predictor),
                            predictor = gsub('thrombin.generation.endogenous.potential.cat', 'Thrombin Generation (Endogenous Potential) : Dichotomised', predictor),
                            predictor = gsub('thrombin.generation.peak', 'Thrombin Generation (Peak)', predictor),
                            predictor = gsub('thrombin.generation.peak.cat', 'Thrombin Generation (Peak) : Dichotomised', predictor),
                            predictor = gsub('thrombin.generation.time.to.peak', 'Thrombin Generation (Time to Peak)', predictor),
                            predictor = gsub('thrombin.generation.time.to.peak.cat', 'Thrombin Generation (Time to Peak) : Dichotomised', predictor),
                            predictor = gsub('plasmin.antiplasmin', 'Plasmin-antiplasmin', predictor),
                            predictor = gsub('plasmin.antiplasmin.cat', 'Plasmin-antiplasmin : Dichotomised', predictor),
                            predictor = gsub('prothrombin.fragments', 'Prothombin Fragments', predictor),
                            predictor = gsub('prothrombin.fragments.cat', 'Prothombin Fragments : Dichotomised', predictor),
                            predictor = gsub('soluble.tissue.factor', 'Soluble Tissue Factor', predictor),
                            predictor = gsub('soluble.tissue.factor.cat', 'Soluble Tissue Factor : Dichotomised', predictor),
                            predictor = gsub('troponin', 'Troponin', predictor),
                            predictor = gsub('troponin.cat', 'Troponin : Dichotomised', predictor),
                            predictor = gsub('bnp', 'BNP', predictor),
                            predictor = gsub('bnp.cat', 'BNP : Dichotomised', predictor),
                            predictor = gsub('mrproanp', 'MRproANP', predictor),
                            predictor = gsub('mrproanp.cat', 'MRproANP : Dichotomised', predictor),
                            predictor = gsub('medical.complication', 'Medical Complication (Delphi reviewed)', predictor),
                            predictor = gsub('obstetric.complication', 'Obstetric Complication (Delphi reviewed)', predictor)
                            )
    if(classification != 'vte'){
        results$table <- results$table[c('predictor', 'levels', 'No PE', 'PE')]
    }
    else{
        results$table <- results$table[c('predictor', 'levels', 'No VTE', 'VTE')]
    }
    ## Meaningful label for predictor
    ## Filter the data frame, need to remove all Non-recruited and
    ## those who can not be classified as PE/No PE
    results$df <- dplyr::filter_(df, !is.na(classification)) %>%
                  dplyr::select_(.dots = c(classification, predictor)) %>%
                  mutate(obs = rownames(.),
                         use = complete.cases(.)) %>%
                  dplyr::filter(use == TRUE) %>%
                  dplyr::select(-use)
    results$df$obs <- rownames(results$df)
    ## Test the model (converting the grouping factor back to numeric)
    results$fitted <- glm(.formula,
                          data   = results$df,
                          family = 'binomial')
    ## Obtain Confidence Intervals
    results$ci <- confint(results$fitted) %>%
                  as.data.frame() %>%
                  mutate(term = rownames(.),
                         model = model)
    names(results$ci) <- gsub('2.5 %',  'lci', names(results$ci))
    names(results$ci) <- gsub('97.5 %', 'uci', names(results$ci))
    ## Use Broom to sweep up/tidy the results
    results$tidied    <- broom::tidy(results$fitted)
    ## Merge in the CI
    results$tidied <- left_join(results$tidied,
                                results$ci)

    results$tidied <- results$tidied %>%
        mutate(term = case_when(.$term == '(Intercept)' ~  '(Intercept)',
                                .$term == 'simplified.age' ~  'Geneva : Age > 35',
                                .$term == 'simplified.prev.dvt.pe' ~ 'Geneva : Previous DVT/PE',
                                .$term == 'simplified.surgery' ~ 'Geneva : Surgery',
                                .$term == 'simplified.neoplasm' ~ 'Geneva : Neoplasm',
                                .$term == 'simplified.lower.limb.unilateral.pain' ~ 'Geneva : Unilateral lower limb pain',
                                .$term == 'simplified.haemoptysis' ~ 'Geneva : Haemoptysis',
                                .$term == 'simplified.heart.rate' ~ 'Geneva : Heart Rate',
                                .$term == 'simplified.pain.palpitations' ~ 'Geneva : Pain on limb palpitation',
                                .$term == 'perc.age' ~ 'PERC : Age (> 35)',
                                .$term == 'perc.heart.rate' ~ 'PERC : Heart Rate',
                                .$term == 'perc.o2' ~ 'PERC : O2 Saturation',
                                .$term == 'perc.prev.dvt.pe' ~ 'PERC : Previous DVT/PE',
                                .$term == 'perc.surgery' ~ 'PERC : Surgery',
                                .$term == 'perc.haemoptysis' ~ 'PERC : Haemoptysis',
                                .$term == 'perc.leg.swelling' ~ 'PERC : Unilateral Leg Swelling',
                                .$term == 'wells.dvt' ~ 'Wells : Clinical DVT',
                                .$term == 'wells.alternative.permissive' ~ 'Wells : PE most likely (Permissive)',
                                .$term == 'wells.alternative.strict' ~ 'Wells : PE most likely (Strict)',
                                .$term == 'wells.heart.rate' ~ 'Wells : Heart Rate',
                                .$term == 'wells.surgery.immobil' ~ 'Wells : Surgery/Immobility',
                                .$term == 'wells.dvt.pe' ~ 'Wells : Previous DVT/PE',
                                .$term == 'wells.haemoptysis' ~ 'Wells : Haemoptysis',
                                .$term == 'wells.neoplasm' ~ 'Wells : Neoplasm',
                                .$term == 'delphi.haemoptysisTRUE' ~ 'Delphi : Haemoptysis',
                                .$term == 'delphi.pleuriticTRUE' ~ 'Delphi : Pleuritic',
                                .$term == 'delphi.history.dvt.peTRUE' ~ 'Delphi : Previous DVT/PE',
                                .$term == 'delphi.family.historyTRUE' ~ 'Delphi : Family History',
                                .$term == 'delphi.medical.historyTRUE' ~ 'Delphi : Surgery/Injury',
                                .$term == 'delphi.obstetric.complicationTRUE' ~ 'Delphi : Obstetric Complications',
                                .$term == 'delphi.medical.complicationTRUE' ~ 'Delphi : Medical Complications',
                                .$term == 'delphi.gestationTRUE' ~ 'Delphi : 3rd Trimester/Post-Partum',
                                .$term == 'delphi.bmiTRUE' ~ 'Delphi : BMI > 30',
                                .$term == 'delphi.dvtTRUE' ~ 'Delphi : DVT',
                                .$term == 'delphi.o2.saturationTRUE' ~ 'Delphi : O2 Saturation',
                                .$term == 'delphi.heart.rateTRUE' ~ 'Delphi : Heart Rate',
                                .$term == 'delphi.respiratory.rateTRUE' ~ 'Delphi : Respiratory Rate',
                                .$term == 'age.catYoung' ~ 'Age (Young)',
                                .$term == 'age.catOld' ~ 'Age (Old)',
                                .$term == 'age' ~ 'Age (Continuous)',
                                .$term == 'smokinggave up prior to pregnancy' ~ 'Ex-smoker (Prior)',
                                .$term == 'smokinggave up during pregnancy' ~ 'Ex-smoker (During)',
                                .$term == 'smokingcurrent' ~ 'Current Smoker',
                                .$term == 'smoking.catNon-smoker' ~ 'Smoking (Binary) : Non-Smoker',
                                .$term == 'smoking.Smoker' ~ 'Smoking (Binary) : Smoker',
                                .$term == 'temperature.catLow' ~ 'Temperature (Low)',
                                .$term == 'temperature.catHigh' ~ 'Temperature (High)',
                                .$term == 'temperature' ~ 'Temperature (Continuous)',
                                .$term == 'bp.diastolic.catLow' ~ 'Diastolic (Low)',
                                .$term == 'bp.diastolic.catHigh' ~ 'Diastolic (High)',
                                .$term == 'bp.diastolic' ~ 'Diastolic (Continuous)',
                                .$term == 'bp.systolic.catLow' ~ 'Systolic (Low)',
                                .$term == 'bp.systolic.catHigh' ~ 'Systolic (High)',
                                .$term == 'bp.systolic' ~ 'Systolic (Continuous)',
                                .$term == 'o2.saturation.catLow' ~ 'O2 Saturation (Low)',
                                .$term == 'o2.saturation.catHigh' ~ 'O2 Saturation (High)',
                                .$term == 'o2.saturation' ~ 'O2 Saturation (Continuous)',
                                .$term == 'respiratory.rate.catLow' ~ 'Respiratory Rate (Low)',
                                .$term == 'respiratory.rate.catHigh' ~ 'Respiratory Rate (High)',
                                .$term == 'respiratory.rate' ~ 'Respiratory Rate (Continuous)',
                                .$term == 'heart.rate.catLow' ~ 'Heart Rate (Low)',
                                .$term == 'heart.rate.catHigh' ~ 'Heart Rate (High)',
                                .$term == 'heart.rate' ~ 'Heart Rate (Continuous)',
                                .$term == 'bmi.catLow' ~ 'BMI (Low)',
                                .$term == 'bmi.catHigh' ~ 'BMI (High)',
                                .$term == 'bmi' ~ 'BMI (Continuous)',
                                .$term == 'Ticked' ~ '',
                                .$term == 'presenting.features.pleuriticTicked' ~ 'Presenting : Pleuritic',
                                .$term == 'presenting.features.non.pleuriticTicked' ~ 'Presenting : Non-Pleuritic',
                                .$term == 'presenting.features.sob.exertionTicked' ~ 'Presenting : Shortness of Breath (Exertion)',
                                .$term == 'presenting.features.sob.restTicked' ~ 'Presenting : Shortness of Breath (Rest)',
                                .$term == 'presenting.features.haemoptysisTicked' ~ 'Presenting : Haemoptysis',
                                .$term == 'presenting.features.coughTicked' ~ 'Presenting : Cough',
                                .$term == 'presenting.features.syncopeTicked' ~ 'Presenting : Syncope',
                                .$term == 'presenting.features.palpitationsTicked' ~ 'Presenting : Palpitations',
                                .$term == 'presenting.features.otherTicked' ~ 'Presenting : Other',
                                .$term == 'medical.complicationYes' ~ 'VTE-related Medical Problem',
                                .$term == 'medical.complicationNo' ~ 'No VTE-related Medical Problem',
                                .$term == 'obstetric.complicationYes' ~ 'VTE-related Obstetric Problem',
                                .$term == 'obstetric.complicationNo' ~ 'No VTE-related Obstetric Problem',
                                .$term == 'pregnancies.under.cat>= 1 previous pregnancy < 24 weeks' ~ '>= 1 Pregnancy < 24 weeks',
                                .$term == 'pregnancies.under.catNo previous pregnancies < 24 weeks' ~ 'No Pregnancy < 24 weeks',
                                .$term == 'pregnancies.over.cat>= 1 previous pregnancy > 24 weeks' ~ '>= 1 Pregnancy > 24 weeks',
                                .$term == 'pregnancies.over.catNo previous pregnancies > 24 weeks' ~ 'No Pregnancy > 24 weeks',
                                .$term == 'pregnancies.under' ~ 'Pregnancies < 24 weeks (Continuous)',
                                .$term == 'pregnancies.over' ~ 'Pregnancies > 24 weeks (Continuous)',
                                .$term == 'prev.preg.problemNo' ~ 'No Previous Pregnancy Problems',
                                .$term == 'prev.preg.problemYes' ~ 'Previous Pregnancy Problems',
                                .$term == 'history.thrombosisNo' ~ 'No Family History of Thrombosis',
                                .$term == 'history.thrombosisYes' ~ 'Family History of Thrombosis',
                                .$term == 'history.veinsNo' ~ 'No History of Varicose Veins',
                                .$term == 'history.veinsYes' ~ 'History of Varicose Veins',
                                .$term == 'history.iv.drugNo' ~ 'No History of IV Drug use',
                                .$term == 'history.iv.drugYes' ~ 'History of IV Drug use',
                                .$term == 'thrombosisNo' ~ 'NoHistory of Thrombosis',
                                .$term == 'thrombosisYes' ~ 'History of Thrombosis',
                                .$term == 'trimester1st Trimester' ~ '1st Trimester',
                                .$term == 'trimester2nd Trimester' ~ '2nd Trimester',
                                .$term == 'trimester3rd Trimester' ~ '3rd Trimester',
                                .$term == 'trimesterPost-Partum' ~ 'Post-Partum',
                                .$term == 'cesareanCesarean' ~ 'Cesarean',
                                .$term == 'cesareanNo Cesarean' ~ 'No Cesarean',
                                .$term == 'preg.postPostpartum' ~ 'Post-partum',
                                .$term == 'preg.postPregnant' ~ 'Pregnant',
                                .$term == 'existing.medicalNo' ~ 'No Exiting Medical',
                                .$term == 'existing.medicalYes' ~ 'Exiting Medical',
                                .$term == 'injuryNo' ~ 'No Injury',
                                .$term == 'injuryYes' ~ 'Injury',
                                .$term == 'this.pregnancy.problemsYes' ~ 'Problems with this Pregnancy',
                                .$term == 'this.pregnancy.problemsNo' ~ 'No Problems with this Pregnancy',
                                .$term == 'surgeryYes' ~ 'Surgery in previous 4 weeks',
                                .$term == 'surgeryNo' ~ 'No Surgery in previous 4 weeks',
                                .$term == 'dvt.catYes' ~ 'Clinical signs of DVT',
                                .$term == 'dvt.catNo' ~ 'No clinical signs of DVT',
                                .$term == 'thromboYes' ~ 'Known Thrombophilia',
                                .$term == 'thromboNo' ~ 'No Known Thrombophilia',
                                .$term == 'thrombo.eventYes' ~ 'Thrombotic Event this Pregnancy',
                                .$term == 'thrombo.eventNo' ~ 'No Thrombotic Event this Pregnancy',
                                .$term == 'thromb.eventYes' ~ 'Other Thrombotic event during this pregnancy',
                                .$term == 'thromb.eventNo' ~ 'No Other Thrombotic event during this pregnancy',
                                .$term == 'thromboprophylaxisYes' ~ 'Thromboprophylaxis',
                                .$term == 'thromboprophylaxisNo' ~ 'No Thromboprophylaxis',
                                .$term == 'medical.probsYes' ~ 'Pre-existing medical problems',
                                .$term == 'medical.probsNo' ~ 'No Pre-existing medical problems',
                                .$term == 'multiple.pregYes' ~ 'Multiple Pregnancy',
                                .$term == 'multiple.pregNo' ~ 'No Multiple Pregnancy',
                                .$term == 'travelYes' ~ 'Long-haul travel during pregnancy',
                                .$term == 'travelNo' ~ 'No Long-haul travel during pregnancy',
                                .$term == 'immobilYes' ~ '>=3 days Immobility/bed rest during pregnancy',
                                .$term == 'immobilNo' ~ '<3 days Immobility/bed rest during pregnancy',
                                .$term == 'ecgNormal ECG' ~ 'ECG : Normal',
                                .$term == 'ecgAbnormal ECG' ~ 'ECG : Abnormal',
                                .$term == 'ecgNot performed ECG' ~ 'ECG : Not Performed',
                                .$term == 'ecg.catAbnormal ECG' ~ 'ECG (Binary) : Abnormal',
                                .$term == 'ecg.catNormal ECG' ~ 'ECG (Binary) : Abnormal',
                                .$term == 'ecg.peNormal / Not performed / Missing' ~ 'Normal / Not Performed / Missing ECG',
                                .$term == 'ecg.peAbnormal - PE' ~ 'PE related ECG abnormality',
                                .$term == 'xrayNormal' ~ 'X-ray : Normal',
                                .$term == 'xrayAbnormal' ~ 'X-ray : Abnormal',
                                .$term == 'xrayNot performed' ~ 'X-ray : Not Performed',
                                .$term == 'xray.catAbnormal X-Ray' ~ 'X-ray (Binary) : Abnormal',
                                .$term == 'xray.peNormal / Not performed / Missing' ~ 'Normal / Not Performed / Missing CXR',
                                .$term == 'xray.peAbnormal - PE' ~ 'PE Related CXR abnormality',
                                .$term == 'xray.peAbnormal - Other' ~ 'Other CXR abnormality',
                                .$term == 'aptt.catNormal' ~ 'APTT : Normal',
                                .$term == 'aptt.catAbnormal' ~ 'APTT : Abnormal',
                                .$term == 'aptt' ~ 'APTT',
                                .$term == 'prothombin.timeNormal' ~ 'Prothombin (Time)',
                                .$term == 'prothombin.timeAbnormal' ~ 'Prothombin (Time)',
                                .$term == 'prothombin.time' ~ 'Prothombin (Time)',
                                .$term == 'clauss.fibrinogenNormal' ~ 'Clauss Fibrinogen',
                                .$term == 'clauss.fibrinogenAbnormal' ~ 'Clauss Fibrinogen',
                                .$term == 'clauss.fibrinogen' ~ 'Clauss Fibrinogen',
                                .$term == 'ddimer.innovanceNormal' ~ 'D-Dimer (Innovance)',
                                .$term == 'ddimer.innovanceAbnormal' ~ 'D-Dimer (Innovance)',
                                .$term == 'ddimer.innovance' ~ 'D-Dimer (Innovance)',
                                .$term == 'ddimer.elisaNormal' ~ 'D-Dimer (ELISA)',
                                .$term == 'ddimer.elisaAbnormal' ~ 'D-Dimer (ELISA)',
                                .$term == 'ddimer.elisa' ~ 'D-Dimer (ELISA)',
                                .$term == 'd.dimer.catNormal' ~ 'D-Dimer (Hospital) : Normal',
                                .$term == 'd.dimer.catAbnormal' ~ 'D-Dimer (Hospital) : Abnormal',
                                .$term == 'd.dimer.gestation.catNormal' ~ 'D-Dimer (Hospital Gestation Specific) : Normal',
                                .$term == 'd.dimer.gestation.catAbnormal' ~ 'D-Dimer (Hospital Gestation Specific) : Abnormal',
                                .$term == 'd.dimer' ~ 'D-Dimer (Hospital Continuous)',
                                .$term == 'thrombin.generation.lag.timeNormal' ~ 'Thrombin Generation (Lag Time) : Normal',
                                .$term == 'thrombin.generation.lag.timeAbnormal' ~ 'Thrombin Generation (Lag Time) : Abnormal',
                                .$term == 'thrombin.generation.lag.time' ~ 'Thrombin Generation (Lag Time)',
                                .$term == 'thrombin.generation.endogenous.potentialNormal' ~ 'Thrombin Generation (Endogenous Potential) : Normal',
                                .$term == 'thrombin.generation.endogenous.potentialAbnormal' ~ 'Thrombin Generation (Endogenous Potential) : Abnormal',
                                .$term == 'thrombin.generation.endogenous.potential' ~ 'Thrombin Generation (Endogenous Potential)',
                                .$term == 'thrombin.generation.peakNormal' ~ 'Thrombin Generation (Peak) : Normal',
                                .$term == 'thrombin.generation.peakAbnormal' ~ 'Thrombin Generation (Peak) : Abnormal',
                                .$term == 'thrombin.generation.peak' ~ 'Thrombin Generation (Peak)',
                                .$term == 'thrombin.generation.time.to.peakNormal' ~ 'Thrombin Generation (Time to Peak) : Normal',
                                .$term == 'thrombin.generation.time.to.peakAbnormal' ~ 'Thrombin Generation (Time to Peak) : Abnormal',
                                .$term == 'thrombin.generation.time.to.peak' ~ 'Thrombin Generation (Time to Peak)',
                                .$term == 'plasmin.antiplasminNormal' ~ 'Plasmin-antiplasmin : Normal',
                                .$term == 'plasmin.antiplasminAbnormal' ~ 'Plasmin-antiplasmin : Abnormal',
                                .$term == 'plasmin.antiplasmin' ~ 'Plasmin-antiplasmin',
                                .$term == 'prothrombin.fragmentsNormal' ~ 'PF 1 + 2 : Normal',
                                .$term == 'prothrombin.fragmentsAbnormal' ~ 'PF 1 + 2 : Abnormal',
                                .$term == 'prothrombin.fragments' ~ 'PF 1 + 2',
                                .$term == 'tissue.factorNormal' ~ 'Tissue Factor : Normal',
                                .$term == 'tissue.factorAbnormal' ~ 'Tissue Factor : Abnormal',
                                .$term == 'tissue.factor' ~ 'Tissue Factor',
                                .$term == 'troponinNormal' ~ 'Troponin : Normal',
                                .$term == 'troponinAbnormal' ~ 'Troponin : Abnormal',
                                .$term == 'troponin' ~ 'Troponin',
                                .$term == 'bnpNormal' ~ 'BNP : Normal',
                                .$term == 'bnpAbnormal' ~ 'BNP : Abnormal',
                                .$term == 'bnp' ~ 'BNP',
                                .$term == 'mrproanpNormal' ~ 'MRProANP : Normal',
                                .$term == 'mrproanpAbnormal' ~ 'MRProANP : Abnormal',
                                .$term == 'mrproanp' ~ 'MRProANP',
                                .$term == '\\.cat' ~ ''))

    ## results$tidied <- mutate(results$tidied,
    ##                          term = gsub('simplified.age', 'Geneva : Age > 35', term),
    ##                          term = gsub('simplified.prev.dvt.pe', 'Geneva : Previous DVT/PE', term),
    ##                          term = gsub('simplified.surgery', 'Geneva : Surgery', term),
    ##                          term = gsub('simplified.neoplasm', 'Geneva : Neoplasm', term),
    ##                          term = gsub('simplified.lower.limb.unilateral.pain', 'Geneva : Unilateral lower limb pain', term),
    ##                          term = gsub('simplified.haemoptysis', 'Geneva : Haemoptysis', term),
    ##                          term = gsub('simplified.heart.rate', 'Geneva : Heart Rate', term),
    ##                          term = gsub('simplified.pain.palpitations', 'Geneva : Pain on limb palpitation', term),
    ##                          term = gsub('perc.Age (Continuous)', 'PERC : Age (> 35)', term),
    ##                          term = gsub('perc.Heart Rate (Continuous)', 'PERC : Heart Rate', term),
    ##                          term = gsub('perc.o2', 'PERC : O2 Saturation', term),
    ##                          term = gsub('perc.prev.dvt.pe', 'PERC : Previous DVT/PE', term),
    ##                          term = gsub('perc.surgery', 'PERC : Surgery', term),
    ##                          term = gsub('perc.haemoptysis', 'PERC : Haemoptysis', term),
    ##                          term = gsub('perc.leg.swelling', 'PERC : Unilateral Leg Swelling', term),
    ##                          term = gsub('wells.dvt', 'Wells : Clinical DVT', term),
    ##                          term = gsub('wells.alternative.permissive', 'Wells : PE most likely (Permissive)', term),
    ##                          term = gsub('wells.alternative.strict', 'Wells : PE most likely (Strict)', term),
    ##                          term = gsub('wells.Heart Rate (Continuous)', 'Wells : Heart Rate', term),
    ##                          term = gsub('wells.surgery.immobil', 'Wells : Surgery/Immobility', term),
    ##                          term = gsub('wells.dvt.pe', 'Wells : Previous DVT/PE', term),
    ##                          term = gsub('wells.haemoptysis', 'Wells : Haemoptysis', term),
    ##                          term = gsub('wells.neoplasm', 'Wells : Neoplasm', term),
    ##                          term = gsub('delphi.haemoptysisTRUE', 'Delphi : Haemoptysis', term),
    ##                          term = gsub('delphi.pleuriticTRUE', 'Delphi : Pleuritic', term),
    ##                          term = gsub('delphi.history.dvt.peTRUE', 'Delphi : Previous DVT/PE', term),
    ##                          term = gsub('delphi.family.historyTRUE', 'Delphi : Family History', term),
    ##                          term = gsub('delphi.medical.historyTRUE', 'Delphi : Surgery/Injury', term),
    ##                          term = gsub('delphi.obstetric.complicationTRUE', 'Delphi : Obstetric Complications', term),
    ##                          term = gsub('delphi.medical.complicationTRUE', 'Delphi : Medical Complications', term),
    ##                          term = gsub('delphi.gestationTRUE', 'Delphi : 3rd Trimester/Post-Partum', term),
    ##                          term = gsub('delphi.BMI (Continuous)TRUE', 'Delphi : BMI > 30', term),
    ##                          term = gsub('delphi.dvtTRUE', 'Delphi : DVT', term),
    ##                          term = gsub('delphi.O2 Saturation (Continuous)TRUE', 'Delphi : O2 Saturation', term),
    ##                          term = gsub('delphi.Heart Rate (Continuous)TRUE', 'Delphi : Heart Rate', term),
    ##                          term = gsub('delphi.Respiratory Rate (Continuous)TRUE', 'Delphi : Respiratory Rate', term),
    ##                          term = gsub('age.catYoung', 'Age (Young)', term),
    ##                          term = gsub('age.catOld', 'Age (Old)', term),
    ##                          term = gsub('age', 'Age (Continuous)', term),
    ##                          term = gsub('smokinggave up prior to pregnancy', 'Ex-smoker (Prior)', term),
    ##                          term = gsub('smokinggave up during pregnancy', 'Ex-smoker (During)', term),
    ##                          term = gsub('smokingcurrent', 'Current Smoker', term),
    ##                          term = gsub('smoking.catNon-smoker', 'Smoking (Binary) : Non-Smoker', term),
    ##                          term = gsub('smoking.Smoker', 'Smoking (Binary) : Smoker', term),
    ##                          term = gsub('temperature.catLow', 'Temperature (Low)', term),
    ##                          term = gsub('temperature.catHigh', 'Temperature (High)', term),
    ##                          term = gsub('temperature', 'Temperature (Continuous)', term),
    ##                          term = gsub('bp.diastolic.catLow', 'Diastolic (Low)', term),
    ##                          term = gsub('bp.diastolic.catHigh', 'Diastolic (High)', term),
    ##                          term = gsub('bp.diastolic', 'Diastolic (Continuous)', term),
    ##                          term = gsub('bp.systolic.catLow', 'Systolic (Low)', term),
    ##                          term = gsub('bp.systolic.catHigh', 'Systolic (High)', term),
    ##                          term = gsub('bp.systolic', 'Systolic (Continuous)', term),
    ##                          term = gsub('o2.saturation.catLow', 'O2 Saturation (Low)', term),
    ##                          term = gsub('o2.saturation.catHigh', 'O2 Saturation (High)', term),
    ##                          term = gsub('o2.saturation', 'O2 Saturation (Continuous)', term),
    ##                          term = gsub('respiratory.rate.catLow', 'Respiratory Rate (Low)', term),
    ##                          term = gsub('respiratory.rate.catHigh', 'Respiratory Rate (High)', term),
    ##                          term = gsub('respiratory.rate', 'Respiratory Rate (Continuous)', term),
    ##                          term = gsub('heart.rate.catLow', 'Heart Rate (Low)', term),
    ##                          term = gsub('heart.rate.catHigh', 'Heart Rate (High)', term),
    ##                          term = gsub('heart.rate', 'Heart Rate (Continuous)', term),
    ##                          term = gsub('bmi.catLow', 'BMI (Low)', term),
    ##                          term = gsub('bmi.catHigh', 'BMI (High)', term),
    ##                          term = gsub('bmi', 'BMI (Continuous)', term),
    ##                          term = gsub('Ticked', '', term),
    ##                          term = gsub('presenting.features.pleuritic', 'Presenting : Pleuritic', term),
    ##                          term = gsub('presenting.features.non.pleuritic', 'Presenting : Non-Pleuritic', term),
    ##                          term = gsub('presenting.features.sob.exertion', 'Presenting : Shortness of Breath (Exertion)', term),
    ##                          term = gsub('presenting.features.sob.rest', 'Presenting : Shortness of Breath (Rest)', term),
    ##                          term = gsub('presenting.features.haemoptysis', 'Presenting : Haemoptysis', term),
    ##                          term = gsub('presenting.features.cough', 'Presenting : Cough', term),
    ##                          term = gsub('presenting.features.syncope', 'Presenting : Syncope', term),
    ##                          term = gsub('presenting.features.palpitations', 'Presenting : Palpitations', term),
    ##                          term = gsub('presenting.features.other', 'Presenting : Other', term),
    ##                          term = gsub('medical.complicationYes', 'Medical Complication (Delphi reviewed)', term),
    ##                          term = gsub('medical.complicationNo', 'Medical Complication (Delphi reviewed)', term),
    ##                          term = gsub('obstetric.complicationYes', 'Obstetric Complication (Delphi reviewed)', term),
    ##                          term = gsub('obstetric.complicationNo', 'Obstetric Complication (Delphi reviewed)', term),
    ##                          term = gsub('pregnancies.under.cat>= 1 previous pregnancy < 24 weeks', '>= 1 Pregnancy < 24 weeks', term,),
    ##                          term = gsub('pregnancies.under.catNo previous pregnancies < 24 weeks', 'No Pregnancy < 24 weeks', term),
    ##                          term = gsub('pregnancies.over.cat>= 1 previous pregnancy > 24 weeks', '>= 1 Pregnancy > 24 weeks', term),
    ##                          term = gsub('pregnancies.over.catNo previous pregnancies > 24 weeks', 'No Pregnancy > 24 weeks', term),
    ##                          term = gsub('pregnancies.under', 'Pregnancies < 24 weeks (Continuous)', term),
    ##                          term = gsub('pregnancies.over', 'Pregnancies > 24 weeks (Continuous)', term),
    ##                          term = gsub('prev.preg.problemNo', 'No Previous Pregnancy Problems', term),
    ##                          term = gsub('prev.preg.problemYes', 'Previous Pregnancy Problems', term),
    ##                          term = gsub('history.thrombosisNo', 'No Family History of Thrombosis', term),
    ##                          term = gsub('history.thrombosisYes', 'Family History of Thrombosis', term),
    ##                          term = gsub('history.veinsNo', 'No History of Varicose Veins', term),
    ##                          term = gsub('history.veinsYes', 'History of Varicose Veins', term),
    ##                          term = gsub('history.iv.drugNo', 'No History of IV Drug use', term),
    ##                          term = gsub('history.iv.drugYes', 'History of IV Drug use', term),
    ##                          term = gsub('thrombosisNo', 'NoHistory of Thrombosis', term),
    ##                          term = gsub('thrombosisYes', 'History of Thrombosis', term),
    ##                          term = gsub('trimester1st Trimester', '1st Trimester', term),
    ##                          term = gsub('trimester2nd Trimester', '2nd Trimester', term),
    ##                          term = gsub('trimester3rd Trimester', '3rd Trimester', term),
    ##                          term = gsub('trimesterPost-Partum', 'Post-Partum', term),
    ##                          term = gsub('cesareanCesarean', 'Cesarean', term),
    ##                          term = gsub('cesareanNo Cesarean', 'No Cesarean', term),
    ##                          term = gsub('preg.postPostpartum', 'Post-partum', term),
    ##                          term = gsub('preg.postPregnant', 'Pregnant', term),
    ##                          term = gsub('existing.medicalNo', 'No Exiting Medical', term),
    ##                          term = gsub('existing.medicalYes', 'Exiting Medical', term),
    ##                          term = gsub('injuryNo', 'No Injury', term),
    ##                          term = gsub('injuryYes', 'Injury', term),
    ##                          term = gsub('this.pregnancy.problemsYes', 'Problems with this Pregnancy', term),
    ##                          term = gsub('this.pregnancy.problemsNo', 'No Problems with this Pregnancy', term),
    ##                          term = gsub('surgeryYes', 'Surgery in previous 4 weeks', term),
    ##                          term = gsub('surgeryNo', 'No Surgery in previous 4 weeks', term),
    ##                          term = gsub('dvt.catYes', 'Clinical DVT', term),
    ##                          term = gsub('dvt.catNo', 'No Clinical DVT', term),
    ##                          term = gsub('thromboYes', 'Known Thrombophilia', term),
    ##                          term = gsub('thromboNo', 'No Known Thrombophilia', term),
    ##                          term = gsub('thrombo.eventYes', 'Previous Thrombotic Event', term),
    ##                          term = gsub('thrombo.eventNo', 'No Previous Thrombotic Event', term),
    ##                          term = gsub('thromboprophylaxisYes', 'Thromboprophylaxis', term),
    ##                          term = gsub('thromboprophylaxisNo', 'No Thromboprophylaxis', term),
    ##                          term = gsub('multiple.pregYes', 'Multiple Pregnancy', term),
    ##                          term = gsub('multiple.pregNo', 'No Multiple Pregnancy', term),
    ##                          term = gsub('travelYes', 'Long-haul travel during pregnancy', term),
    ##                          term = gsub('travelNo', 'No Long-haul travel during pregnancy', term),
    ##                          term = gsub('immobilYes', '>=3 days Immobility/bed rest during pregnancy', term),
    ##                          term = gsub('immobilNo', '<3 days Immobility/bed rest during pregnancy', term),
    ##                          term = gsub('ecgNormal ECG', 'ECG : Normal', term),
    ##                          term = gsub('ecgAbnormal ECG', 'ECG : Abnormal', term),
    ##                          term = gsub('ecgNot performed ECG', 'ECG : Not Performed', term),
    ##                          term = gsub('ecg.catAbnormal ECG', 'ECG (Binary) : Abnormal', term),
    ##                          term = gsub('ecg.catNormal ECG', 'ECG (Binary) : Abnormal', term),
    ##                          term = gsub('ecg.peNormal / Not performed / Missing', 'ECG (PE Related) : Normal / Not Performed / Missing', term),
    ##                          term = gsub('ecg.peAbnormal - PE', 'ECG (PE Related) : Abnormal - PE', term),
    ##                          term = gsub('xrayNormal', 'X-ray : Normal', term),
    ##                          term = gsub('xrayAbnormal', 'X-ray : Abnormal', term),
    ##                          term = gsub('xrayNot performed', 'X-ray : Not Performed', term),
    ##                          term = gsub('xray.catAbnormal X-Ray', 'X-ray (Binary) : Abnormal', term),
    ##                          term = gsub('xray.peNormal / Not performed / Missing', 'X-ray (PE Related) : Normal / Not Performed / Missing', term),
    ##                          term = gsub('xray.peAbnormal - PE', 'X-ray (PE Related) : Abnormal - PE', term),
    ##                          term = gsub('xray.peAbnormal - Other', 'X-ray (PE Related) : Abnormal - Other', term),
    ##                          term = gsub('aptt.catNormal', 'APTT : Normal', term),
    ##                          term = gsub('aptt.catAbnormal', 'APTT : Abnormal', term),
    ##                          term = gsub('aptt', 'APTT', term),
    ##                          term = gsub('prothombin.timeNormal', 'Prothombin (Time)', term),
    ##                          term = gsub('prothombin.timeAbnormal', 'Prothombin (Time)', term),
    ##                          term = gsub('prothombin.time', 'Prothombin (Time)', term),
    ##                          term = gsub('clauss.fibrinogenNormal', 'Clauss Fibrinogen', term),
    ##                          term = gsub('clauss.fibrinogenAbnormal', 'Clauss Fibrinogen', term),
    ##                          term = gsub('clauss.fibrinogen', 'Clauss Fibrinogen', term),
    ##                          term = gsub('ddimer.innovanceNormal', 'D-Dimer (Innovance)', term),
    ##                          term = gsub('ddimer.innovanceAbnormal', 'D-Dimer (Innovance)', term),
    ##                          term = gsub('ddimer.innovance', 'D-Dimer (Innovance)', term),
    ##                          term = gsub('ddimer.elisaNormal', 'D-Dimer (ELISA)', term),
    ##                          term = gsub('ddimer.elisaAbnormal', 'D-Dimer (ELISA)', term),
    ##                          term = gsub('ddimer.elisa', 'D-Dimer (ELISA)', term),
    ##                          term = gsub('d.dimer.catNormal', 'D-Dimer (Hospital) : Normal', term),
    ##                          term = gsub('d.dimer.catAbnormal', 'D-Dimer (Hospital) : Abnormal', term),
    ##                          term = gsub('d.dimer', 'D-Dimer (Hospital Continuous)', term),
    ##                          term = gsub('thrombin.generation.lag.timeNormal', 'Thrombin Generation (Lag Time) : Normal', term),
    ##                          term = gsub('thrombin.generation.lag.timeAbnormal', 'Thrombin Generation (Lag Time) : Abnormal', term),
    ##                          term = gsub('thrombin.generation.lag.time', 'Thrombin Generation (Lag Time)', term),
    ##                          term = gsub('thrombin.generation.endogenous.potentialNormal', 'Thrombin Generation (Endogenous Potential) : Normal', term),
    ##                          term = gsub('thrombin.generation.endogenous.potentialAbnormal', 'Thrombin Generation (Endogenous Potential) : Abnormal', term),
    ##                          term = gsub('thrombin.generation.endogenous.potential', 'Thrombin Generation (Endogenous Potential)', term),
    ##                          term = gsub('thrombin.generation.peakNormal', 'Thrombin Generation (Peak) : Normal', term),
    ##                          term = gsub('thrombin.generation.peakAbnormal', 'Thrombin Generation (Peak) : Abnormal', term),
    ##                          term = gsub('thrombin.generation.peak', 'Thrombin Generation (Peak)', term),
    ##                          term = gsub('thrombin.generation.time.to.peakNormal', 'Thrombin Generation (Time to Peak) : Normal', term),
    ##                          term = gsub('thrombin.generation.time.to.peakAbnormal', 'Thrombin Generation (Time to Peak) : Abnormal', term),
    ##                          term = gsub('thrombin.generation.time.to.peak', 'Thrombin Generation (Time to Peak)', term),
    ##                          term = gsub('plasmin.antiplasminNormal', 'Plasmin-antiplasmin : Normal', term),
    ##                          term = gsub('plasmin.antiplasminAbnormal', 'Plasmin-antiplasmin : Abnormal', term),
    ##                          term = gsub('plasmin.antiplasmin', 'Plasmin-antiplasmin', term),
    ##                          term = gsub('prothrombin.fragmentsNormal', 'PF 1 + 2 : Normal', term),
    ##                          term = gsub('prothrombin.fragmentsAbnormal', 'PF 1 + 2 : Abnormal', term),
    ##                          term = gsub('prothrombin.fragments', 'PF 1 + 2', term),
    ##                          term = gsub('tissue.factorNormal', 'Tissue Factor : Normal', term),
    ##                          term = gsub('tissue.factorAbnormal', 'Tissue Factor : Abnormal', term),
    ##                          term = gsub('tissue.factor', 'Tissue Factor', term),
    ##                          term = gsub('troponinNormal', 'Troponin : Normal', term),
    ##                          term = gsub('troponinAbnormal', 'Troponin : Abnormal', term),
    ##                          term = gsub('troponin', 'Troponin', term),
    ##                          term = gsub('bnpNormal', 'BNP : Normal', term),
    ##                          term = gsub('bnpAbnormal', 'BNP : Abnormal', term),
    ##                          term = gsub('bnp', 'BNP', term),
    ##                          term = gsub('mrproanpNormal', 'MRProANP : Normal', term),
    ##                          term = gsub('mrproanpAbnormal', 'MRProANP : Abnormal', term),
    ##                          term = gsub('mrproanp', 'MRProANP', term),
    ##                          term = gsub('\\.cat', ' ', term))
    ## Get the predicted response out
    results$augmented <- broom::augment(results$fitted, type.predict = 'response')
    results$glance    <- broom::glance(results$fitted)
    ## Add the predictor to each to make it easier combining
    results$tidied$model    <- model
    results$augmented$model <- model
    results$glance$model    <- model
    ## Get predicted probabilities
    ## results$predicted <- results$fitted %>% predict() %>% as.data.frame()
    ## names(results$predicted) <- c('pred')
    ## results$predicted$obs <- rownames(results$predicted)
    ## results$predicted <- merge(dplyr::select(results$df, obs, pe),
    ##                            results$predicted,
    ##                            by = c('obs'))
    ## results$predicted <- cbind(predict(results$fitted, type = 'response'),
    ##                            results$fitted$y) %>%
    ##                      as.data.frame()
    ## names(results$predicted) <- c('predicted', 'pe')
    ## Extract these from the 'augmented' data frame
    results$predicted <- dplyr::select_(results$augmented, classification, '.fitted')
    if(length(predictor) == 1){
        results$predicted$name <- predictor
    }
    else{
        results$predicted$name <- model
    }
    results$predicted$term <- model
    names(results$predicted) <- gsub('.fitted', 'M', names(results$predicted))
    names(results$predicted) <- gsub(classification, 'D', names(results$predicted))
    ## Return ROC curve for this model
    results$roc <- ggplot(results$predicted,
                          aes(d = D, m = M)) +
                   geom_roc() +
                   guides(guide = guide_legend(title = '')) +
                   ggtitle(paste0('ROC curve for ', model)) +
                   style_roc() + theme_bw()
    ## Add the AUC
    results$auc <- calc_auc(results$roc)
    results$roc <- results$roc +
                   annotate('text', x = 0.75, y = 0.25,
                            label = paste0('AUC = ', round(results$auc$AUC, 3)))
    ## ToDo 20170220 - Calculate sensitivity, specificity, PPV/NPV
    return(results)
}
